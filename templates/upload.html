{% extends "base.html" %}
{% block title %}2D Pipeline - HumanBody{% endblock %}

{% block content %}
<h1>2D Pipeline <small style="color:#888;">(2D Detector + MocapNET v2.1)</small></h1>

<div class="upload-area" id="dropZone">
    <form method="post" enctype="multipart/form-data" id="uploadForm">
        {% csrf_token %}

        <div class="drop-zone" id="dropTarget">
            <i class="fas fa-cloud-upload-alt fa-3x"></i>
            <p>Drag & drop video here or click to browse</p>
            <input type="file" name="video" id="videoInput" accept="video/*" required>
        </div>

        <div class="form-group">
            <label>2D Detector:</label>
            <div class="pipeline-options">
                <label class="pipeline-option">
                    <input type="radio" name="pipeline" value="mediapipe"
                        {% if default_2d == 'mediapipe' %}checked{% endif %}>
                    <span class="pipeline-label">MediaPipe</span>
                    <span class="pipeline-desc">CPU, schnell, ~50 AP</span>
                </label>
                <label class="pipeline-option {% if not status.openpose_exe or not status.openpose_models %}disabled{% endif %}">
                    <input type="radio" name="pipeline" value="openpose"
                        {% if default_2d == 'openpose' %}checked{% endif %}
                        {% if not status.openpose_exe or not status.openpose_models %}disabled{% endif %}>
                    <span class="pipeline-label">OpenPose</span>
                    <span class="pipeline-desc">
                        {% if status.openpose_exe and status.openpose_models %}CUDA GPU, 61 AP, Legacy{% else %}nicht verf&uuml;gbar{% endif %}
                    </span>
                </label>
                <label class="pipeline-option {% if not status.yolo11 %}disabled{% endif %}">
                    <input type="radio" name="pipeline" value="yolo11"
                        {% if default_2d == 'yolo11' %}checked{% endif %}
                        {% if not status.yolo11 %}disabled{% endif %}>
                    <span class="pipeline-label">YOLO11-l</span>
                    <span class="pipeline-desc">
                        {% if status.yolo11 %}GPU, schnell, 66 AP{% else %}nicht installiert (pip install ultralytics){% endif %}
                    </span>
                </label>
                <label class="pipeline-option {% if not status.rtmpose %}disabled{% endif %}">
                    <input type="radio" name="pipeline" value="rtmpose"
                        {% if default_2d == 'rtmpose' %}checked{% endif %}
                        {% if not status.rtmpose %}disabled{% endif %}>
                    <span class="pipeline-label">RTMPose-l &star;</span>
                    <span class="pipeline-desc">
                        {% if status.rtmpose %}GPU, sehr schnell, 77 AP{% else %}nicht installiert (pip install rtmlib){% endif %}
                    </span>
                </label>
                <label class="pipeline-option {% if not status.vitpose %}disabled{% endif %}">
                    <input type="radio" name="pipeline" value="vitpose"
                        {% if default_2d == 'vitpose' %}checked{% endif %}
                        {% if not status.vitpose %}disabled{% endif %}>
                    <span class="pipeline-label">ViTPose-H</span>
                    <span class="pipeline-desc">
                        {% if status.vitpose %}GPU, langsamer, 79 AP (h&ouml;chste Genauigkeit){% else %}nicht installiert{% endif %}
                    </span>
                </label>
            </div>
        </div>

        <div class="form-group" style="margin-top:10px;">
            <small style="color:#888;">Alle Detektoren geben Body25 (OpenPose-Format) aus &rarr; MocapNET v2.1 (CMU Skeleton, 164 Joints) hebt automatisch auf 3D.</small>
        </div>

        <div class="form-group">
            <label for="fps">FPS:</label>
            <input type="number" name="fps" id="fps" value="30" min="1" max="120" step="0.1">
        </div>

        <button type="submit" class="btn btn-primary" id="uploadBtn">
            <i class="fas fa-upload"></i> Upload
        </button>
    </form>
</div>

{% if v21_jobs %}
<div class="job-list-section">
    <div style="display:flex; align-items:center; gap:10px; margin-bottom:10px;">
        <h3 style="margin:0;">Uploaded Videos</h3>
        <button class="btn btn-sm btn-danger" id="bulkDeleteBtn" style="display:none;" onclick="bulkDelete()">
            <i class="fas fa-trash"></i> Delete Selected
        </button>
    </div>
    <table class="processed-table" id="jobTable">
        <thead>
            <tr>
                <th style="width:30px;"><input type="checkbox" id="selectAll" onchange="toggleSelectAll(this)"></th>
                <th class="sortable" onclick="sortTable('name')">Name <i class="fas fa-sort"></i></th>
                <th>Pipeline</th>
                <th>Status</th>
                <th class="sortable" onclick="sortTable('size')">Size <i class="fas fa-sort"></i></th>
                <th class="sortable" onclick="sortTable('date')">Created <i class="fas fa-sort"></i></th>
                <th>Process</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="jobTableBody">
            {% for job in v21_jobs %}
            <tr id="row-{{ job.id }}" data-name="{{ job.name|lower }}" data-size="{{ job.video_size }}" data-date="{{ job.created_at|date:'Y-m-d H:i:s' }}">
                <td><input type="checkbox" class="job-check" value="{{ job.id }}" onchange="updateBulkBtn()"></td>
                <td>{{ job.name }}</td>
                <td><span class="badge badge-{{ job.pipeline }}">{{ job.get_pipeline_display }}</span></td>
                <td id="status-{{ job.id }}">
                    {% if job.status == 'complete' %}
                        <span style="color:#2ecc71;"><i class="fas fa-check-circle"></i> Complete</span>
                    {% elif job.status == 'failed' %}
                        <span style="color:#e74c3c;"><i class="fas fa-times-circle"></i> Failed</span>
                    {% elif job.status == 'pending' %}
                        <span style="color:#f39c12;"><i class="fas fa-clock"></i> Pending</span>
                    {% else %}
                        <div class="inline-progress">
                            <span class="status-text"><i class="fas fa-spinner fa-spin"></i> {{ job.get_status_display }}</span>
                            <div class="progress-bar-mini">
                                <div class="progress-fill-mini" style="width:{{ job.progress }}%"></div>
                            </div>
                            <span class="progress-pct">{{ job.progress }}%</span>
                        </div>
                    {% endif %}
                </td>
                <td>{{ job.video_size_display }}</td>
                <td>{{ job.created_at|date:"d.m.Y H:i" }}</td>
                <td>
                    <div style="display:flex; gap:4px; align-items:center;">
                        <select class="pipeline-select" id="pl-{{ job.id }}" data-current="{{ job.pipeline }}">
                            <option value="mediapipe" {% if job.pipeline == 'mediapipe' %}selected{% endif %}>MediaPipe</option>
                            <option value="openpose" {% if job.pipeline == 'openpose' %}selected{% endif %}>OpenPose</option>
                            <option value="rtmpose" {% if job.pipeline == 'rtmpose' %}selected{% endif %}>RTMPose</option>
                            <option value="vitpose" {% if job.pipeline == 'vitpose' %}selected{% endif %}>ViTPose</option>
                            <option value="yolo11" {% if job.pipeline == 'yolo11' %}selected{% endif %}>YOLO11</option>
                        </select>
                        <button class="btn btn-sm btn-primary" onclick="startProcessing('{{ job.id }}', this)">
                            <i class="fas fa-play"></i>
                        </button>
                    </div>
                </td>
                <td style="display:flex; gap:5px;">
                    {% if job.status == 'complete' %}
                    <a class="btn btn-sm btn-primary" href="{% url 'job_result' job.id %}">
                        <i class="fas fa-eye"></i> View
                    </a>
                    {% elif job.status != 'pending' %}
                    <a class="btn btn-sm btn-secondary" href="{% url 'job_status' job.id %}">
                        <i class="fas fa-info-circle"></i> Status
                    </a>
                    {% endif %}
                    <button class="btn btn-sm btn-danger" onclick="deleteJob('{{ job.id }}', this)">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endif %}

<div class="info-box">
    <h3>Vergleich 2D Detektoren</h3>
    <table class="compare-table">
        <thead>
            <tr>
                <th>Detektor</th>
                <th>Genauigkeit</th>
                <th>Geschwindigkeit</th>
                <th>GPU VRAM</th>
                <th>RAM</th>
                <th>Empfehlung</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td><strong>MediaPipe</strong></td>
                <td>~50 AP</td>
                <td>30&ndash;50 FPS (CPU)</td>
                <td>0 GB</td>
                <td>~0.5 GB</td>
                <td>Kein GPU n&ouml;tig</td>
            </tr>
            <tr>
                <td><strong>OpenPose</strong></td>
                <td>61 AP</td>
                <td>~15&ndash;30 FPS</td>
                <td>~2 GB</td>
                <td>~3 GB</td>
                <td>Legacy</td>
            </tr>
            <tr>
                <td><strong>YOLO11-L</strong></td>
                <td>66 AP</td>
                <td>~100&ndash;130 FPS</td>
                <td>2&ndash;4 GB</td>
                <td>~3 GB</td>
                <td>Gut &amp; schnell</td>
            </tr>
            <tr style="background:#1a2a1a;">
                <td><strong>RTMPose-L</strong></td>
                <td>77 AP</td>
                <td>~200&ndash;350 FPS</td>
                <td>1&ndash;2 GB</td>
                <td>~2 GB</td>
                <td><span style="color:#2ecc71;">&starf; Empfohlen</span></td>
            </tr>
            <tr>
                <td><strong>ViTPose-H</strong></td>
                <td>79 AP</td>
                <td>~50&ndash;80 FPS</td>
                <td>4&ndash;6 GB</td>
                <td>~4 GB</td>
                <td><span style="color:#e67e22;">&starf; Beste Qualit&auml;t</span></td>
            </tr>
        </tbody>
    </table>
    <p style="margin-top:8px; color:#888;"><small>AP = COCO Average Precision (h&ouml;her = besser). Geschwindigkeit gesch&auml;tzt f&uuml;r RTX 3060.<br>
    Alle Detektoren konvertieren ihre Keypoints ins Body25 (OpenPose) Format f&uuml;r MocapNET v2.1.</small></p>

    <h3 style="margin-top:1.5rem;">Processing Steps</h3>
    <ol>
        <li>Video &rarr; 2D Joint Detection (gew&auml;hlter Detektor)</li>
        <li>2D Keypoints &rarr; Body25 CSV (OpenPose-Format, 25 Joints)</li>
        <li>Body25 CSV &rarr; MocapNET v2.1 Neural Network &rarr; BVH (CMU Skeleton, 164 Joints)</li>
    </ol>
    <p><strong>Unterst&uuml;tzte Formate:</strong> MP4, WebM, AVI, MOV</p>
</div>
{% endblock %}

{% block extra_scripts %}
<style>
.sortable { cursor: pointer; user-select: none; }
.sortable:hover { color: #3498db; }
.inline-progress { display: flex; align-items: center; gap: 6px; min-width: 180px; }
.inline-progress .status-text { font-size: 0.82rem; white-space: nowrap; color: #3498db; }
.progress-bar-mini { flex: 1; height: 6px; background: #2a2a3e; border-radius: 3px; overflow: hidden; min-width: 60px; }
.progress-fill-mini { height: 100%; background: linear-gradient(90deg, #3498db, #2ecc71); border-radius: 3px; transition: width 0.5s; }
.inline-progress .progress-pct { font-size: 0.75rem; color: #888; min-width: 30px; text-align: right; }
/* Detail row */
.detail-row td { padding: 0 !important; border-top: none !important; }
.detail-panel {
    margin: 0 16px 12px 40px;
    padding: 14px 18px;
    background: var(--bg-card, #1e1e2e);
    border: 1px solid var(--border, #333);
    border-radius: 8px;
}
.detail-panel .progress-bar {
    height: 10px; background: #2a2a3e; border-radius: 5px; overflow: hidden; margin: 8px 0;
}
.detail-panel .progress-fill {
    height: 100%; background: linear-gradient(90deg, #3498db, #2ecc71); border-radius: 5px; transition: width 0.5s;
    display: flex; align-items: center; justify-content: center;
    font-size: 0.7rem; color: #fff; min-width: 24px;
}
.detail-panel .detail-header {
    display: flex; align-items: center; gap: 12px; margin-bottom: 6px;
}
.detail-panel .detail-phase { color: var(--text-muted, #888); font-size: 0.85rem; }
.detail-panel .detail-progress-text { color: var(--text-muted, #888); font-size: 0.82rem; margin-bottom: 8px; }
.detail-panel .detail-actions { display: flex; gap: 8px; margin-top: 10px; }
.detail-panel .detail-error {
    margin-top: 8px; padding: 8px 12px; background: rgba(231,76,60,0.15);
    border: 1px solid rgba(231,76,60,0.3); border-radius: 6px; color: #e74c3c; font-size: 0.85rem;
}
.detail-panel .detail-thumb {
    margin-top: 10px; display: flex; gap: 12px; align-items: flex-start;
}
.detail-panel .detail-thumb img {
    max-width: 200px; border-radius: 6px; border: 1px solid var(--border, #333);
}
</style>
<script>
const dropTarget = document.getElementById('dropTarget');
const videoInput = document.getElementById('videoInput');

dropTarget.addEventListener('click', () => videoInput.click());

// Double-submit guard
document.getElementById('uploadForm').addEventListener('submit', function() {
    var btn = document.getElementById('uploadBtn');
    if (btn.disabled) { event.preventDefault(); return; }
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Uploading...';
});

dropTarget.addEventListener('dragover', (e) => {
    e.preventDefault();
    dropTarget.classList.add('drag-over');
});

dropTarget.addEventListener('dragleave', () => {
    dropTarget.classList.remove('drag-over');
});

dropTarget.addEventListener('drop', (e) => {
    e.preventDefault();
    dropTarget.classList.remove('drag-over');
    if (e.dataTransfer.files.length) {
        videoInput.files = e.dataTransfer.files;
        dropTarget.querySelector('p').textContent = e.dataTransfer.files[0].name;
    }
});

videoInput.addEventListener('change', () => {
    if (videoInput.files.length) {
        dropTarget.querySelector('p').textContent = videoInput.files[0].name;
    }
});

function getCsrf() {
    return document.querySelector('[name=csrfmiddlewaretoken]').value;
}

function deleteJob(jobId, btn) {
    if (!confirm('Delete this job?')) return;
    fetch('/api/job/' + jobId + '/delete/', {
        method: 'POST',
        headers: {'X-CSRFToken': getCsrf()}
    }).then(r => r.json()).then(data => {
        if (data.ok) {
            var detail = document.getElementById('detail-' + jobId);
            if (detail) detail.remove();
            var row = document.getElementById('row-' + jobId);
            if (row) row.remove();
            updateBulkBtn();
            var tbody = document.getElementById('jobTableBody');
            if (tbody && tbody.querySelectorAll('tr:not(.detail-row)').length === 0) {
                var section = tbody.closest('.job-list-section');
                if (section) section.style.display = 'none';
            }
        }
    });
}

function toggleSelectAll(el) {
    document.querySelectorAll('.job-check').forEach(c => c.checked = el.checked);
    updateBulkBtn();
}

function updateBulkBtn() {
    var checked = document.querySelectorAll('.job-check:checked').length;
    var btn = document.getElementById('bulkDeleteBtn');
    if (btn) btn.style.display = checked > 0 ? '' : 'none';
}

function bulkDelete() {
    var ids = Array.from(document.querySelectorAll('.job-check:checked')).map(c => c.value);
    if (!ids.length) return;
    if (!confirm('Delete ' + ids.length + ' job(s)?')) return;
    var btn = document.getElementById('bulkDeleteBtn');
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Deleting...';
    fetch('/api/jobs/bulk-delete/', {
        method: 'POST',
        headers: {'X-CSRFToken': getCsrf(), 'Content-Type': 'application/json'},
        body: JSON.stringify({ids: ids})
    }).then(r => r.json()).then(data => {
        if (data.ok) {
            data.deleted.forEach(id => {
                var detail = document.getElementById('detail-' + id);
                if (detail) detail.remove();
                var row = document.getElementById('row-' + id);
                if (row) row.remove();
            });
            document.getElementById('selectAll').checked = false;
            updateBulkBtn();
            var tbody = document.getElementById('jobTableBody');
            if (tbody && tbody.querySelectorAll('tr:not(.detail-row)').length === 0) {
                var section = tbody.closest('.job-list-section');
                if (section) section.style.display = 'none';
            }
        }
    }).finally(function() {
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-trash"></i> Delete Selected';
    });
}

// --- Phase labels ---
var PHASE_LABELS = {
    'pending': 'Pending', 'detecting_2d': '2D Pose Detection',
    'openpose': '2D Detection (GPU)', 'openpose_csv': 'CSV Convert',
    'mediapipe': '2D Detection (CPU)', 'lifting_3d': '3D Pose Estimation',
    'mocapnet': '3D Pose Estimation', 'v4_processing': 'MocapNET v4',
    'processing': 'Processing', 'complete': 'Complete', 'failed': 'Failed'
};

// --- Detail row management ---
function getOrCreateDetailRow(jobId) {
    var existing = document.getElementById('detail-' + jobId);
    if (existing) return existing;
    var mainRow = document.getElementById('row-' + jobId);
    if (!mainRow) return null;
    var colSpan = mainRow.children.length;
    var tr = document.createElement('tr');
    tr.id = 'detail-' + jobId;
    tr.className = 'detail-row';
    tr.innerHTML = '<td colspan="' + colSpan + '">' +
        '<div class="detail-panel">' +
            '<div class="detail-header">' +
                '<span class="badge" id="detail-badge-' + jobId + '">Starting</span>' +
                '<span class="detail-phase" id="detail-phase-' + jobId + '"></span>' +
            '</div>' +
            '<div class="progress-bar"><div class="progress-fill" id="detail-fill-' + jobId + '" style="width:0%"><span id="detail-pct-' + jobId + '">0%</span></div></div>' +
            '<div class="detail-progress-text" id="detail-text-' + jobId + '">Starting...</div>' +
            '<div class="detail-thumb" id="detail-thumb-' + jobId + '">' +
                '<img src="/api/thumbnail/' + jobId + '/" alt="Video" onerror="this.style.display=\'none\'">' +
            '</div>' +
            '<div class="detail-error" id="detail-error-' + jobId + '" style="display:none;"></div>' +
            '<div class="detail-actions" id="detail-actions-' + jobId + '">' +
                '<button class="btn btn-sm btn-danger" onclick="stopProcessing(\'' + jobId + '\', this)"><i class="fas fa-stop"></i> Stop</button>' +
            '</div>' +
        '</div></td>';
    mainRow.after(tr);
    return tr;
}

function stopProcessing(jobId, btn) {
    if (!confirm('Stop processing?')) return;
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Stopping...';
    fetch('/api/job/' + jobId + '/stop/', {
        method: 'POST',
        headers: {'X-CSRFToken': getCsrf()}
    }).then(r => r.json()).then(function() {
        btn.innerHTML = '<i class="fas fa-stop"></i> Stopped';
    }).catch(function() {
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-stop"></i> Stop';
    });
}

// --- Inline processing start + detail row + polling ---
function startProcessing(jobId, btn) {
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    var sel = document.getElementById('pl-' + jobId);
    var body = '';
    if (sel) body = 'pipeline=' + encodeURIComponent(sel.value);
    fetch('/api/job/' + jobId + '/start/', {
        method: 'POST',
        headers: {'X-CSRFToken': getCsrf(), 'Content-Type': 'application/x-www-form-urlencoded'},
        body: body
    }).then(r => r.json()).then(data => {
        if (data.ok) {
            var activeId = jobId;
            if (data.new_job_id) {
                // New job created with different pipeline — add row to table
                activeId = data.new_job_id;
                addNewJobRow(data.new_job_id, data.new_pipeline, data.new_pipeline_display, jobId);
                // Reset original dropdown back to its actual pipeline
                if (sel) sel.value = sel.dataset.current;
                // Re-enable original button
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-play"></i>';
            }
            getOrCreateDetailRow(activeId);
            updateJobUI(activeId, {status: data.status, progress: 0, progress_detail: 'Starting...'});
            startJobPolling(activeId);
        } else {
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-play"></i>';
            alert('Error: ' + (data.error || 'Unknown'));
        }
    }).catch(() => {
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-play"></i>';
    });
}

function addNewJobRow(newJobId, pipeline, pipelineDisplay, sourceJobId) {
    var srcRow = document.getElementById('row-' + sourceJobId);
    if (!srcRow) return;
    var name = srcRow.querySelector('td:nth-child(2)').textContent;
    var sizeText = srcRow.querySelector('td:nth-child(5)').textContent;
    var now = new Date();
    var dateStr = now.toLocaleDateString('de-DE', {day:'2-digit',month:'2-digit',year:'numeric',hour:'2-digit',minute:'2-digit'});
    var tr = document.createElement('tr');
    tr.id = 'row-' + newJobId;
    tr.innerHTML =
        '<td></td>' +
        '<td>' + name + '</td>' +
        '<td><span class="badge badge-' + pipeline + '">' + pipelineDisplay + '</span></td>' +
        '<td id="status-' + newJobId + '"><span style="color:#f39c12;"><i class="fas fa-spinner fa-spin"></i> Starting...</span></td>' +
        '<td>' + sizeText + '</td>' +
        '<td>' + dateStr + '</td>' +
        '<td><div style="display:flex;gap:4px;align-items:center;">' +
            '<select class="pipeline-select" id="pl-' + newJobId + '" data-current="' + pipeline + '">' +
            '<option value="mediapipe"' + (pipeline==='mediapipe'?' selected':'') + '>MediaPipe</option>' +
            '<option value="openpose"' + (pipeline==='openpose'?' selected':'') + '>OpenPose</option>' +
            '<option value="rtmpose"' + (pipeline==='rtmpose'?' selected':'') + '>RTMPose</option>' +
            '<option value="vitpose"' + (pipeline==='vitpose'?' selected':'') + '>ViTPose</option>' +
            '<option value="yolo11"' + (pipeline==='yolo11'?' selected':'') + '>YOLO11</option>' +
            '</select>' +
            '<button class="btn btn-sm btn-primary" onclick="startProcessing(\'' + newJobId + '\', this)">' +
            '<i class="fas fa-play"></i></button></div></td>' +
        '<td style="display:flex;gap:5px;">' +
            '<button class="btn btn-sm btn-danger" onclick="deleteJob(\'' + newJobId + '\', this)"><i class="fas fa-trash"></i></button>' +
        '</td>';
    // Insert at top of table body
    var tbody = document.getElementById('jobTableBody');
    if (tbody.firstChild) tbody.insertBefore(tr, tbody.firstChild);
    else tbody.appendChild(tr);
}

function updateJobUI(jobId, data) {
    // --- Update inline status cell ---
    var cell = document.getElementById('status-' + jobId);
    if (cell) {
        if (data.status === 'complete') {
            cell.innerHTML = '<span style="color:#2ecc71;"><i class="fas fa-check-circle"></i> Complete</span>';
        } else if (data.status === 'failed') {
            cell.innerHTML = '<span style="color:#e74c3c;"><i class="fas fa-times-circle"></i> Failed</span>';
        } else {
            var pct = data.progress || 0;
            var detail = data.progress_detail || data.status || '';
            cell.innerHTML =
                '<div class="inline-progress">' +
                '<span class="status-text"><i class="fas fa-spinner fa-spin"></i> ' + detail.substring(0, 30) + '</span>' +
                '<div class="progress-bar-mini"><div class="progress-fill-mini" style="width:' + pct + '%"></div></div>' +
                '<span class="progress-pct">' + pct + '%</span></div>';
        }
    }

    // --- Update detail row ---
    var detailRow = document.getElementById('detail-' + jobId);
    if (!detailRow) return;

    var badge = document.getElementById('detail-badge-' + jobId);
    var phase = document.getElementById('detail-phase-' + jobId);
    var fill = document.getElementById('detail-fill-' + jobId);
    var pctEl = document.getElementById('detail-pct-' + jobId);
    var textEl = document.getElementById('detail-text-' + jobId);
    var errorEl = document.getElementById('detail-error-' + jobId);
    var actionsEl = document.getElementById('detail-actions-' + jobId);

    var p = data.progress || 0;
    if (badge) {
        badge.textContent = PHASE_LABELS[data.status] || data.status;
        badge.className = 'badge badge-' + data.status;
    }
    if (phase) phase.textContent = PHASE_LABELS[data.status] || '';
    if (fill) fill.style.width = p + '%';
    if (pctEl) pctEl.textContent = p + '%';
    if (textEl) textEl.textContent = data.progress_detail || '';

    // Reset the process button (spinner → play) when job is done
    if (data.status === 'complete' || data.status === 'failed') {
        var mainRow = document.getElementById('row-' + jobId);
        if (mainRow) {
            var procBtn = mainRow.querySelector('button[onclick*="startProcessing"]');
            if (procBtn) {
                procBtn.disabled = false;
                procBtn.innerHTML = '<i class="fas fa-play"></i>';
            }
        }
    }

    if (data.status === 'complete') {
        if (errorEl) errorEl.style.display = 'none';
        if (actionsEl) {
            actionsEl.innerHTML =
                '<a class="btn btn-sm btn-primary" href="/process/' + jobId + '/result/"><i class="fas fa-eye"></i> View Result</a>' +
                (data.bvh_file ? ' <a class="btn btn-sm btn-secondary" href="/api/bvh/' + jobId + '/" download><i class="fas fa-download"></i> Download BVH</a>' : '');
        }
        // Update main row actions too
        var mainRow2 = document.getElementById('row-' + jobId);
        if (mainRow2) {
            var actionsTd = mainRow2.querySelector('td:last-child');
            if (actionsTd && !actionsTd.querySelector('a[href*="result"]')) {
                var a = document.createElement('a');
                a.className = 'btn btn-sm btn-primary';
                a.href = '/process/' + jobId + '/result/';
                a.innerHTML = '<i class="fas fa-eye"></i> View';
                actionsTd.insertBefore(a, actionsTd.firstChild);
            }
        }
    } else if (data.status === 'failed') {
        if (errorEl && data.error) {
            errorEl.style.display = '';
            errorEl.innerHTML = '<strong>Error:</strong> ' + data.error;
        }
        if (actionsEl) actionsEl.innerHTML = '';
    }
}

function startJobPolling(jobId) {
    function poll() {
        fetch('/api/job/' + jobId + '/status/')
            .then(function(r) { return r.json(); })
            .then(function(data) {
                updateJobUI(jobId, data);
                if (data.status !== 'complete' && data.status !== 'failed') {
                    setTimeout(poll, 2000);
                }
            })
            .catch(function() { setTimeout(poll, 5000); });
    }
    setTimeout(poll, 1500);
}

// Auto-expand + poll for jobs that are currently processing
(function() {
    document.querySelectorAll('tr[id^="row-"]').forEach(function(row) {
        var statusCell = row.querySelector('td[id^="status-"]');
        if (statusCell && statusCell.querySelector('.inline-progress')) {
            var jobId = statusCell.id.replace('status-', '');
            getOrCreateDetailRow(jobId);
            startJobPolling(jobId);
        }
    });
})();

// Sortable table (skip detail rows)
var sortDir = {};
function sortTable(key) {
    var tbody = document.getElementById('jobTableBody');
    if (!tbody) return;
    var rows = Array.from(tbody.querySelectorAll('tr:not(.detail-row)'));
    sortDir[key] = !sortDir[key];
    var asc = sortDir[key];
    rows.sort(function(a, b) {
        var va = a.dataset[key] || '';
        var vb = b.dataset[key] || '';
        if (key === 'size') return asc ? (Number(va) - Number(vb)) : (Number(vb) - Number(va));
        return asc ? va.localeCompare(vb) : vb.localeCompare(va);
    });
    rows.forEach(function(row) {
        tbody.appendChild(row);
        var detail = document.getElementById('detail-' + row.id.replace('row-', ''));
        if (detail) tbody.appendChild(detail);
    });
}
</script>
{% endblock %}
