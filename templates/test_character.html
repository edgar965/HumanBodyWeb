{% extends "base.html" %}
{% load static %}

{% block title %}Test Charakter — Vergleich{% endblock %}

{% block extra_head %}
<style>
    /* Override main-content for full-bleed viewer */
    .main-content {
        padding: 0 !important;
        max-width: none !important;
        width: calc(100vw - var(--sidebar-width));
    }
    .viewer-container {
        display: flex;
        width: 100%;
        height: 100vh;
        gap: 0;
        position: relative;
    }

    /* Panels on left & right edges */
    .viewer-panel {
        width: 280px;
        background: var(--bg-secondary);
        border-left: 1px solid var(--border);
        border-right: 1px solid var(--border);
        overflow-y: auto;
        padding: 0;
        flex-shrink: 0;
    }
    .viewer-panel.panel-left { border-left: none; }
    .viewer-panel.panel-right { border-right: none; }

    /* Canvas columns */
    .canvas-wrap {
        flex: 1;
        min-width: 0;
        position: relative;
    }
    .canvas-wrap canvas {
        width: 100%;
        height: 100%;
        display: block;
        background: #111;
        cursor: grab;
    }
    .canvas-wrap canvas:active { cursor: grabbing; }

    /* Divider line between canvases */
    .canvas-divider {
        width: 2px;
        background: var(--border);
        flex-shrink: 0;
    }

    /* Buttons overlay on canvas */
    .viewer-buttons-left {
        position: absolute;
        top: 12px;
        left: 12px;
        z-index: 10;
        display: flex;
        gap: 6px;
    }
    .viewer-btn {
        padding: 8px 14px;
        background: rgba(26, 26, 46, 0.85);
        border: 1px solid var(--border);
        border-radius: 6px;
        color: var(--text-muted);
        cursor: pointer;
        font-size: 0.82rem;
        backdrop-filter: blur(4px);
        transition: all 0.2s;
    }
    .viewer-btn:hover { border-color: var(--accent); color: var(--text); }
    .viewer-btn.active { background: var(--accent); color: #fff; border-color: var(--accent); }

    /* Panel sections (shared by viewer_compare.js generated DOM) */
    .panel-section {
        border-bottom: 1px solid var(--border);
        padding: 12px 16px;
    }
    .panel-section h3 {
        font-size: 0.85rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: var(--accent);
        margin-bottom: 10px;
        cursor: pointer;
        user-select: none;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }
    .panel-section h3 .chevron {
        transition: transform 0.2s;
        font-size: 0.7rem;
    }
    .panel-section.collapsed .panel-body { display: none; }
    .panel-section.collapsed h3 .chevron { transform: rotate(-90deg); }

    .slider-row {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 6px;
    }
    .slider-row label {
        font-size: 0.8rem;
        color: var(--text-muted);
        min-width: 80px;
        flex-shrink: 0;
    }
    .slider-row input[type="range"] {
        flex: 1;
        accent-color: var(--accent);
        height: 4px;
    }
    .slider-row .slider-val {
        font-size: 0.75rem;
        color: var(--text-muted);
        min-width: 35px;
        text-align: right;
    }

    select.viewer-select {
        width: 100%;
        padding: 6px 8px;
        background: var(--bg-card);
        color: var(--text);
        border: 1px solid var(--border);
        border-radius: 4px;
        font-size: 0.85rem;
        margin-bottom: 8px;
    }

    .morph-category { margin-bottom: 4px; }
    .morph-category-header {
        font-size: 0.78rem;
        color: var(--text);
        cursor: pointer;
        padding: 4px 0;
        user-select: none;
    }
    .morph-category-header:hover { color: var(--accent); }
    .morph-category-body { display: none; }
    .morph-category.open .morph-category-body { display: block; }

    .btn-reset {
        padding: 4px 12px;
        font-size: 0.78rem;
        background: var(--bg-card);
        border: 1px solid var(--border);
        border-radius: 4px;
        color: var(--text-muted);
        cursor: pointer;
        float: right;
    }
    .btn-reset:hover { border-color: var(--accent); color: var(--text); }

    .status-bar {
        padding: 8px 16px;
        font-size: 0.75rem;
        color: var(--text-muted);
        border-top: 1px solid var(--border);
        background: var(--bg-primary);
    }
    .status-bar .connected { color: var(--success); }
    .status-bar .disconnected { color: var(--danger); }

    /* Canvas label overlay */
    .canvas-label {
        position: absolute;
        bottom: 12px;
        left: 50%;
        transform: translateX(-50%);
        padding: 4px 14px;
        background: rgba(26, 26, 46, 0.8);
        border: 1px solid var(--border);
        border-radius: 4px;
        color: var(--text-muted);
        font-size: 0.78rem;
        pointer-events: none;
        backdrop-filter: blur(4px);
        white-space: nowrap;
        z-index: 5;
    }

    /* Code Viewer Overlay */
    #code-overlay {
        display: none;
        position: fixed;
        top: 0; left: var(--sidebar-width, 220px); right: 0; bottom: 0;
        z-index: 200;
        background: var(--bg-primary);
        flex-direction: column;
    }
    #code-overlay.open { display: flex; }
    #code-overlay-header {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px 16px;
        background: var(--bg-secondary);
        border-bottom: 1px solid var(--border);
        flex-shrink: 0;
    }
    #code-overlay-header h2 {
        font-size: 0.95rem;
        margin: 0;
        color: var(--accent);
    }
    #code-overlay-close {
        margin-left: auto;
        padding: 6px 14px;
        background: var(--bg-card);
        border: 1px solid var(--border);
        border-radius: 4px;
        color: var(--text);
        cursor: pointer;
        font-size: 0.85rem;
    }
    #code-overlay-close:hover { border-color: var(--accent); }
    .code-tabs {
        display: flex;
        gap: 0;
        background: var(--bg-secondary);
        border-bottom: 1px solid var(--border);
        flex-shrink: 0;
        overflow-x: auto;
    }
    .code-tab {
        padding: 8px 16px;
        font-size: 0.82rem;
        color: var(--text-muted);
        cursor: pointer;
        border-bottom: 2px solid transparent;
        white-space: nowrap;
        transition: all 0.15s;
    }
    .code-tab:hover { color: var(--text); background: var(--bg-card); }
    .code-tab.active {
        color: var(--accent);
        border-bottom-color: var(--accent);
        background: var(--bg-card);
    }
    .code-content {
        flex: 1;
        overflow: auto;
        padding: 0;
    }
    .code-content pre {
        margin: 0;
        padding: 16px;
        font-size: 0.78rem;
        line-height: 1.5;
        tab-size: 4;
    }
    .code-content code {
        font-family: 'JetBrains Mono', 'Cascadia Code', 'Fira Code', Consolas, monospace;
    }
    /* Data diagnostics */
    .diag-section { padding: 16px; border-bottom: 1px solid var(--border); }
    .diag-section h3 { font-size: 0.85rem; color: var(--accent); margin-bottom: 8px; }
    .diag-table { width: 100%; border-collapse: collapse; font-size: 0.78rem; }
    .diag-table th { text-align: left; color: var(--text-muted); padding: 4px 12px 4px 0; border-bottom: 1px solid var(--border); }
    .diag-table td { padding: 4px 12px 4px 0; color: var(--text); }
    .diag-table tr.highlight td { background: rgba(230, 126, 34, 0.15); font-weight: 600; }
    .diag-tag { display: inline-block; padding: 1px 6px; border-radius: 3px; font-size: 0.72rem; margin: 0 2px; }
    .diag-tag.female { background: #e74c8b33; color: #e74c8b; }
    .diag-tag.male { background: #3498db33; color: #3498db; }
    .diag-tag.warn { background: #e67e2233; color: #e67e22; }

    /* CharMorphPlugin character selector in left panel header */
    .charmorph-selector {
        padding: 8px 16px;
        background: var(--bg-card);
        border-bottom: 1px solid var(--border);
    }
    .charmorph-selector label {
        font-size: 0.75rem;
        color: var(--text-muted);
        display: block;
        margin-bottom: 4px;
    }
    .charmorph-selector select {
        width: 100%;
        padding: 4px 6px;
        background: var(--bg-secondary);
        color: var(--text);
        border: 1px solid var(--border);
        border-radius: 4px;
        font-size: 0.82rem;
    }
    .charmorph-selector .charmorph-status {
        font-size: 0.72rem;
        color: var(--text-muted);
        margin-top: 2px;
    }
</style>
{% endblock %}

{% block content %}
<div class="viewer-container">
    <!-- Left Panel: CharMorphPlugin controls (generated by viewer_compare.js) -->
    <div id="panel-left" class="viewer-panel panel-left"></div>

    <!-- Left Canvas: CharMorphPlugin character -->
    <div class="canvas-wrap">
        <canvas id="canvas-left"></canvas>
        <div class="viewer-buttons-left">
            <button id="show-code-btn" class="viewer-btn" title="Source Code anzeigen"><i class="fas fa-code"></i> Code</button>
        </div>
        <div class="canvas-label">CharMorphPlugin (Test)</div>
    </div>

    <!-- Divider -->
    <div class="canvas-divider"></div>

    <!-- Right Canvas: humanbody_core production character -->
    <div class="canvas-wrap">
        <canvas id="canvas-right"></canvas>
        <div class="canvas-label">humanbody_core (Produktion)</div>
    </div>

    <!-- Right Panel: humanbody_core controls (generated by viewer_compare.js) -->
    <div id="panel-right" class="viewer-panel panel-right"></div>
</div>

<!-- Code Viewer Overlay -->
<div id="code-overlay">
    <div id="code-overlay-header">
        <h2><i class="fas fa-code"></i> Source Code — humanbody_core</h2>
        <button id="code-overlay-close"><i class="fas fa-times"></i> Schliessen</button>
    </div>
    <div class="code-tabs" id="code-tabs"></div>
    <div class="code-content" id="code-content">
        <div style="padding:24px;color:var(--text-muted);">Lade Source Code...</div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.9.0/build/styles/atom-one-dark.min.css">
<script src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.9.0/build/highlight.min.js"></script>
<script src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.9.0/build/languages/python.min.js"></script>
<script type="importmap">
{
    "imports": {
        "three": "https://cdn.jsdelivr.net/npm/three@0.170.0/build/three.module.js",
        "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.170.0/examples/jsm/"
    }
}
</script>
<script type="module">
import { createViewer } from '{% static "viewer/viewer_compare.js" %}';

const left = createViewer({
    canvasId: 'canvas-left',
    panelId: 'panel-left',
    apiPrefix: '/api/character-test',
    wsPath: '/ws/character-test/',
    defaultBodyType: 'Caucasian',
    label: 'CharMorphPlugin (Test)',
});

const right = createViewer({
    canvasId: 'canvas-right',
    panelId: 'panel-right',
    apiPrefix: '/api/character',
    wsPath: '/ws/character/',
    defaultBodyType: 'Male_Caucasian',
    label: 'humanbody_core (Produktion)',
});

left.init();
right.init();
</script>
<script>
// --- CharMorphPlugin character selector (left panel) ---
(function() {
    function initCharSelector() {
        fetch('/api/character-test/version/')
            .then(r => r.ok ? r.json() : null)
            .then(d => {
                if (!d) return;

                const leftPanel = document.getElementById('panel-left');
                if (!leftPanel || !d.available_characters || !d.available_characters.length) return;

                // Auto-switch to mb_male if not already active
                if (d.character !== 'mb_male' && d.available_characters.includes('mb_male')) {
                    fetch('/api/character-test/switch/?name=mb_male')
                        .then(r => r.json())
                        .then(r => { if (r.ok) window.location.reload(); });
                    return;
                }

                const selectorDiv = document.createElement('div');
                selectorDiv.className = 'charmorph-selector';

                const lbl = document.createElement('label');
                lbl.textContent = 'CharMorphPlugin Character';
                selectorDiv.appendChild(lbl);

                const sel = document.createElement('select');
                d.available_characters.forEach(name => {
                    const opt = document.createElement('option');
                    opt.value = name;
                    opt.textContent = name;
                    if (name === d.character) opt.selected = true;
                    sel.appendChild(opt);
                });
                selectorDiv.appendChild(sel);

                const status = document.createElement('div');
                status.className = 'charmorph-status';
                status.textContent = d.character + ' aktiv';
                selectorDiv.appendChild(status);

                const firstSection = leftPanel.querySelector('.panel-section');
                if (firstSection && firstSection.nextSibling) {
                    leftPanel.insertBefore(selectorDiv, firstSection.nextSibling);
                } else {
                    leftPanel.appendChild(selectorDiv);
                }

                sel.addEventListener('change', function() {
                    const name = this.value;
                    if (!name) return;
                    status.textContent = 'Wechsle zu ' + name + '...';
                    sel.disabled = true;

                    fetch('/api/character-test/switch/?name=' + encodeURIComponent(name))
                        .then(r => r.json())
                        .then(d => {
                            if (d.ok) {
                                status.textContent = name + ' geladen, lade Seite neu...';
                                window.location.reload();
                            } else {
                                status.textContent = 'Fehler: ' + (d.error || 'Unbekannt');
                                sel.disabled = false;
                            }
                        })
                        .catch(err => {
                            status.textContent = 'Fehler: ' + err;
                            sel.disabled = false;
                        });
                });
            })
            .catch(() => {});
    }

    setTimeout(initCharSelector, 100);
})();
</script>
<script>
// --- Code Viewer Overlay (unchanged) ---
(function() {
    const overlay = document.getElementById('code-overlay');
    const showBtn = document.getElementById('show-code-btn');
    const closeBtn = document.getElementById('code-overlay-close');
    const tabsEl = document.getElementById('code-tabs');
    const contentEl = document.getElementById('code-content');
    let sourceData = null;

    showBtn.addEventListener('click', () => {
        overlay.classList.add('open');
        if (!sourceData) loadSource();
    });
    closeBtn.addEventListener('click', () => overlay.classList.remove('open'));
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') overlay.classList.remove('open');
    });

    function formatBytes(b) {
        if (b < 1024) return b + ' B';
        return (b / 1024).toFixed(1) + ' KB';
    }

    function loadSource() {
        contentEl.innerHTML = '<div style="padding:24px;color:var(--text-muted);">Lade Source Code...</div>';
        fetch('/api/character-test/source/')
            .then(r => r.ok ? r.json() : Promise.reject('Not found'))
            .then(data => {
                sourceData = data;
                renderTabs(data);
            })
            .catch(err => {
                contentEl.innerHTML = '<div style="padding:24px;color:#e74c3c;">Fehler: ' + err + '</div>';
            });
    }

    function renderTabs(data) {
        tabsEl.innerHTML = '';
        const diagTab = document.createElement('div');
        diagTab.className = 'code-tab active';
        diagTab.textContent = 'Data Diagnostics';
        diagTab.onclick = () => selectTab(diagTab, () => renderDiagnostics(data.data_diagnostics));
        tabsEl.appendChild(diagTab);

        if (data.charmorph_files && data.charmorph_files.length) {
            const cmOrder = ['morpher_cores.py', 'morphs.py', 'charlib.py'];
            const sorted = data.charmorph_files.sort((a, b) => {
                const ia = cmOrder.indexOf(a.name);
                const ib = cmOrder.indexOf(b.name);
                return (ia < 0 ? 99 : ia) - (ib < 0 ? 99 : ib);
            });
            sorted.forEach(f => {
                const tab = document.createElement('div');
                tab.className = 'code-tab';
                tab.textContent = 'CM: ' + f.name;
                tab.style.color = '#e67e22';
                tab.onclick = () => selectTab(tab, () => renderFile(f, 'CharMorphPlugin'));
                tabsEl.appendChild(tab);
            });
        }

        const sep = document.createElement('div');
        sep.style.cssText = 'border-left:1px solid var(--border);margin:0 4px;';
        tabsEl.appendChild(sep);

        const fileOrder = ['character.py', 'morphing.py', '__init__.py', 'config.py', 'mesh.py'];
        const sortedFiles = data.files.sort((a, b) => {
            const ia = fileOrder.indexOf(a.name);
            const ib = fileOrder.indexOf(b.name);
            return (ia < 0 ? 99 : ia) - (ib < 0 ? 99 : ib);
        });
        sortedFiles.forEach(f => {
            const tab = document.createElement('div');
            tab.className = 'code-tab';
            tab.textContent = f.name;
            tab.onclick = () => selectTab(tab, () => renderFile(f, 'humanbody_core'));
            tabsEl.appendChild(tab);
        });

        renderDiagnostics(data.data_diagnostics);
    }

    function selectTab(tab, renderFn) {
        tabsEl.querySelectorAll('.code-tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        renderFn();
    }

    function renderFile(f, source) {
        contentEl.innerHTML = '';
        const hdr = document.createElement('div');
        hdr.style.cssText = 'padding:8px 16px;background:var(--bg-secondary);border-bottom:1px solid var(--border);font-size:0.82rem;';
        if (source === 'CharMorphPlugin') {
            hdr.innerHTML = '<span style="color:#e67e22;font-weight:600;">CharMorphPlugin</span> (Original, git 69e914e) &mdash; <code>' + f.name + '</code>';
        } else {
            hdr.innerHTML = '<span style="color:var(--accent);font-weight:600;">humanbody_core</span> (TestCharakter) &mdash; <code>' + f.name + '</code>';
        }
        contentEl.appendChild(hdr);
        const pre = document.createElement('pre');
        const code = document.createElement('code');
        code.className = 'language-python';
        code.textContent = f.content;
        pre.appendChild(code);
        contentEl.appendChild(pre);
        if (window.hljs) hljs.highlightElement(code);
    }

    function renderDiagnostics(diag) {
        let html = '';

        html += '<div class="diag-section"><h3>L1 Body Types (Basis-Meshes)</h3>';
        if (diag.l1 && diag.l1.length) {
            html += '<table class="diag-table"><tr><th>Name</th><th>Vertices</th><th>Shape</th><th>Size</th><th>Dtype</th></tr>';
            diag.l1.forEach(l => {
                const isMale = l.name.startsWith('Male_');
                const isCauc = l.name === 'Male_Caucasian';
                const cls = isCauc ? ' class="highlight"' : '';
                const tag = isMale
                    ? '<span class="diag-tag male">Male</span>'
                    : '<span class="diag-tag female">Female</span>';
                html += '<tr' + cls + '><td>' + tag + ' ' + l.name + '</td>';
                if (l.error) {
                    html += '<td colspan="4" style="color:#e74c3c;">' + l.error + '</td>';
                } else {
                    html += '<td>' + l.vertex_count.toLocaleString() + '</td>';
                    html += '<td>[' + l.shape.join(', ') + ']</td>';
                    html += '<td>' + formatBytes(l.size_bytes) + '</td>';
                    html += '<td>' + l.dtype + '</td>';
                }
                html += '</tr>';
            });
            html += '</table>';
            const counts = new Set(diag.l1.filter(l => !l.error).map(l => l.vertex_count));
            if (counts.size > 1) {
                html += '<p style="margin-top:8px;"><span class="diag-tag warn">WARNUNG</span> '
                    + 'Unterschiedliche Vertex-Counts: ' + [...counts].join(' vs ') + '. '
                    + 'Male und Female haben verschiedene Topologien!</p>';
            }
        } else {
            html += '<p style="color:var(--text-muted);">Keine L1 Dateien gefunden.</p>';
        }
        html += '</div>';

        html += '<div class="diag-section"><h3>Gender Delta</h3>';
        if (diag.gender_delta) {
            const gd = diag.gender_delta;
            html += '<table class="diag-table"><tr><th>File</th><th>Vertices</th><th>Shape</th><th>Size</th></tr>';
            html += '<tr><td>' + gd.file + '</td>';
            html += '<td>' + gd.vertex_count.toLocaleString() + '</td>';
            html += '<td>[' + gd.shape.join(', ') + ']</td>';
            html += '<td>' + formatBytes(gd.size_bytes) + '</td></tr></table>';
            if (diag.l1 && diag.l1.length) {
                const maleCounts = diag.l1.filter(l => l.name.startsWith('Male_') && !l.error).map(l => l.vertex_count);
                const femaleCounts = diag.l1.filter(l => l.name.startsWith('Female_') && !l.error).map(l => l.vertex_count);
                if (maleCounts.length && maleCounts[0] !== gd.vertex_count) {
                    html += '<p><span class="diag-tag warn">PROBLEM</span> '
                        + 'gender_male.npy hat ' + gd.vertex_count.toLocaleString() + ' vertices, '
                        + 'aber Male L1 hat ' + maleCounts[0].toLocaleString() + '. '
                        + 'Das Gender-Delta kann nicht auf Male-Meshes angewendet werden!</p>';
                }
                if (femaleCounts.length && femaleCounts[0] === gd.vertex_count) {
                    html += '<p><span class="diag-tag female">INFO</span> '
                        + 'gender_male.npy passt zu Female-Topologie (' + gd.vertex_count.toLocaleString() + ' verts). '
                        + 'Es ist als Delta auf Female gedacht, nicht auf Male.</p>';
                }
            }
        } else {
            html += '<p style="color:var(--text-muted);">Kein gender_male.npy vorhanden.</p>';
        }
        html += '</div>';

        html += '<div class="diag-section"><h3>L2 Packed Morphs</h3>';
        if (diag.l2_packed && diag.l2_packed.length) {
            diag.l2_packed.forEach(p => {
                html += '<div style="margin-bottom:8px;">';
                html += '<strong>' + p.file + '</strong>';
                if (p.error) {
                    html += ' <span style="color:#e74c3c;">' + p.error + '</span>';
                } else {
                    html += ' — ' + p.morph_count + ' Morphs, ' + formatBytes(p.size_bytes);
                    html += '<br><span style="font-size:0.72rem;color:var(--text-muted);">'
                        + p.morph_names.join(', ')
                        + (p.morph_count > 20 ? ', ...' : '')
                        + '</span>';
                }
                html += '</div>';
            });
        } else {
            html += '<p style="color:var(--text-muted);">Keine L2 Packs gefunden.</p>';
        }
        html += '</div>';

        html += '<div class="diag-section"><h3>Data Files</h3>';
        if (diag.data_files && diag.data_files.length) {
            html += '<table class="diag-table"><tr><th>File</th><th>Size</th></tr>';
            diag.data_files.forEach(f => {
                html += '<tr><td>' + f.name + '</td><td>' + formatBytes(f.size_bytes) + '</td></tr>';
            });
            html += '</table>';
        }
        html += '</div>';

        html += '<div class="diag-section"><h3>Code-Flow: Male_Caucasian</h3>';
        html += '<div style="font-size:0.82rem;line-height:1.6;color:var(--text);">';
        html += '<ol style="padding-left:20px;">';
        html += '<li><code>MorphData.load()</code> — Liest alle L1/*.npy Dateien. Male_Caucasian.npy wird als Basis geladen.</li>';
        html += '<li><code>CharacterState.set_body_type("Male_Caucasian")</code> — Setzt <code>self._basis = l1["Male_Caucasian"]</code></li>';
        html += '<li><code>get_l2_for_type("Male_Caucasian")</code> — Lädt L2_packed/__main__.npz + L2_packed/Caucasian.npz</li>';
        html += '<li><code>compute()</code> — Startet mit <code>self._basis.copy()</code> (Male_Caucasian L1)</li>';
        html += '<li><strong>Gender Delta</strong> — <code>gender_male.npy</code> wird addiert wenn <code>self.gender > 0</code>.<br>';
        html += '<span class="diag-tag warn">PROBLEM</span> Wenn gender_male.npy eine andere Vertex-Anzahl hat als Male L1, crasht es oder erzeugt Mist!</li>';
        html += '<li><strong>L2 Morphs</strong> — Alle Slider-Deltas werden auf die Vertices addiert.</li>';
        html += '</ol>';
        html += '</div></div>';

        contentEl.innerHTML = html;
    }
})();
</script>
{% endblock %}
