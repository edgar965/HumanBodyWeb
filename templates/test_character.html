{% extends "base.html" %}
{% load static %}

{% block title %}Test Charakter — MocapNET{% endblock %}

{% block extra_head %}
<style>
    /* Override main-content for full-bleed viewer */
    .main-content {
        padding: 0 !important;
        max-width: none !important;
        width: calc(100vw - var(--sidebar-width));
    }
    .viewer-container {
        display: flex;
        width: 100%;
        height: 100vh;
        gap: 0;
        position: relative;
    }
    .canvas-wrap {
        flex: 1;
        min-width: 0;
        position: relative;
    }
    #viewer-canvas {
        width: 100%;
        height: 100%;
        display: block;
        background: #111;
        cursor: grab;
    }
    #viewer-canvas:active { cursor: grabbing; }
    .viewer-buttons {
        position: absolute;
        top: 12px;
        right: 12px;
        z-index: 10;
        display: flex;
        gap: 6px;
    }
    .viewer-btn {
        padding: 8px 14px;
        background: rgba(26, 26, 46, 0.85);
        border: 1px solid var(--border);
        border-radius: 6px;
        color: var(--text-muted);
        cursor: pointer;
        font-size: 0.82rem;
        backdrop-filter: blur(4px);
        transition: all 0.2s;
    }
    .viewer-btn:hover { border-color: var(--accent); color: var(--text); }
    .viewer-btn.active { background: var(--accent); color: #fff; border-color: var(--accent); }
    .viewer-buttons-left {
        position: absolute;
        top: 12px;
        left: 12px;
        z-index: 10;
        display: flex;
        gap: 6px;
    }

    .viewer-panel {
        width: 320px;
        background: var(--bg-secondary);
        border-left: 1px solid var(--border);
        overflow-y: auto;
        padding: 0;
        flex-shrink: 0;
    }
    .panel-section {
        border-bottom: 1px solid var(--border);
        padding: 12px 16px;
    }
    .panel-section h3 {
        font-size: 0.85rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: var(--accent);
        margin-bottom: 10px;
        cursor: pointer;
        user-select: none;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }
    .panel-section h3 .chevron {
        transition: transform 0.2s;
        font-size: 0.7rem;
    }
    .panel-section.collapsed .panel-body { display: none; }
    .panel-section.collapsed h3 .chevron { transform: rotate(-90deg); }

    .slider-row {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 6px;
    }
    .slider-row label {
        font-size: 0.8rem;
        color: var(--text-muted);
        min-width: 100px;
        flex-shrink: 0;
    }
    .slider-row input[type="range"] {
        flex: 1;
        accent-color: var(--accent);
        height: 4px;
    }
    .slider-row .slider-val {
        font-size: 0.75rem;
        color: var(--text-muted);
        min-width: 35px;
        text-align: right;
    }

    select.viewer-select {
        width: 100%;
        padding: 6px 8px;
        background: var(--bg-card);
        color: var(--text);
        border: 1px solid var(--border);
        border-radius: 4px;
        font-size: 0.85rem;
        margin-bottom: 8px;
    }

    .asset-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 6px;
    }
    .asset-btn {
        padding: 6px 8px;
        font-size: 0.78rem;
        background: var(--bg-card);
        border: 1px solid var(--border);
        border-radius: 4px;
        color: var(--text-muted);
        cursor: pointer;
        text-align: center;
        transition: all 0.2s;
    }
    .asset-btn:hover { border-color: var(--accent); color: var(--text); }
    .asset-btn.active {
        background: var(--accent);
        color: #fff;
        border-color: var(--accent);
    }
    .asset-btn.disabled {
        opacity: 0.4;
        cursor: not-allowed;
    }

    .anim-tree {
        max-height: 300px;
        overflow-y: auto;
        border: 1px solid var(--border);
        border-radius: 4px;
        margin-bottom: 8px;
    }
    .anim-category {
        border-bottom: 1px solid var(--border);
    }
    .anim-category:last-child { border-bottom: none; }
    .anim-category-header {
        font-size: 0.82rem;
        color: var(--text);
        cursor: pointer;
        padding: 8px 12px;
        user-select: none;
        display: flex;
        align-items: center;
        gap: 8px;
        transition: background 0.15s;
    }
    .anim-category-header:hover { background: var(--bg-card); }
    .anim-category-header .cat-chevron {
        font-size: 0.65rem;
        transition: transform 0.2s;
        color: var(--text-muted);
    }
    .anim-category.open .cat-chevron { transform: rotate(90deg); }
    .anim-category-header .cat-count {
        font-size: 0.72rem;
        color: var(--text-muted);
        margin-left: auto;
    }
    .anim-category-body {
        display: none;
    }
    .anim-category.open .anim-category-body { display: block; }
    .anim-item {
        font-size: 0.78rem;
        color: var(--text-muted);
        padding: 5px 12px 5px 28px;
        cursor: pointer;
        transition: all 0.15s;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .anim-item:hover { background: var(--bg-card); color: var(--text); }
    .anim-item.active {
        background: var(--accent);
        color: #fff;
    }
    .anim-item .frames {
        font-size: 0.7rem;
        opacity: 0.7;
    }

    .anim-speed {
        display: flex;
        gap: 8px;
        align-items: center;
        margin-bottom: 8px;
    }
    .anim-speed label {
        font-size: 0.75rem;
        color: var(--text-muted);
        white-space: nowrap;
        min-width: 80px;
    }
    .anim-speed input[type="range"] { flex: 1; accent-color: var(--accent); }
    .anim-controls {
        display: flex;
        gap: 6px;
        align-items: center;
        margin-bottom: 4px;
    }
    .anim-controls button {
        padding: 6px 12px;
        background: var(--bg-card);
        border: 1px solid var(--border);
        border-radius: 4px;
        color: var(--text);
        cursor: pointer;
        font-size: 0.85rem;
    }
    .anim-controls button:hover { border-color: var(--accent); }
    .anim-controls input[type="range"] { flex: 1; accent-color: var(--accent); }
    .anim-info {
        font-size: 0.75rem;
        color: var(--text-muted);
        margin-top: 4px;
    }

    .status-bar {
        padding: 8px 16px;
        font-size: 0.75rem;
        color: var(--text-muted);
        border-top: 1px solid var(--border);
        background: var(--bg-primary);
    }
    .status-bar .connected { color: var(--success); }
    .status-bar .disconnected { color: var(--danger); }

    /* Code Viewer Overlay */
    #code-overlay {
        display: none;
        position: fixed;
        top: 0; left: var(--sidebar-width, 220px); right: 0; bottom: 0;
        z-index: 200;
        background: var(--bg-primary);
        flex-direction: column;
    }
    #code-overlay.open { display: flex; }
    #code-overlay-header {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px 16px;
        background: var(--bg-secondary);
        border-bottom: 1px solid var(--border);
        flex-shrink: 0;
    }
    #code-overlay-header h2 {
        font-size: 0.95rem;
        margin: 0;
        color: var(--accent);
    }
    #code-overlay-close {
        margin-left: auto;
        padding: 6px 14px;
        background: var(--bg-card);
        border: 1px solid var(--border);
        border-radius: 4px;
        color: var(--text);
        cursor: pointer;
        font-size: 0.85rem;
    }
    #code-overlay-close:hover { border-color: var(--accent); }
    .code-tabs {
        display: flex;
        gap: 0;
        background: var(--bg-secondary);
        border-bottom: 1px solid var(--border);
        flex-shrink: 0;
        overflow-x: auto;
    }
    .code-tab {
        padding: 8px 16px;
        font-size: 0.82rem;
        color: var(--text-muted);
        cursor: pointer;
        border-bottom: 2px solid transparent;
        white-space: nowrap;
        transition: all 0.15s;
    }
    .code-tab:hover { color: var(--text); background: var(--bg-card); }
    .code-tab.active {
        color: var(--accent);
        border-bottom-color: var(--accent);
        background: var(--bg-card);
    }
    .code-content {
        flex: 1;
        overflow: auto;
        padding: 0;
    }
    .code-content pre {
        margin: 0;
        padding: 16px;
        font-size: 0.78rem;
        line-height: 1.5;
        tab-size: 4;
    }
    .code-content code {
        font-family: 'JetBrains Mono', 'Cascadia Code', 'Fira Code', Consolas, monospace;
    }
    /* Data diagnostics panel */
    .diag-section {
        padding: 16px;
        border-bottom: 1px solid var(--border);
    }
    .diag-section h3 {
        font-size: 0.85rem;
        color: var(--accent);
        margin-bottom: 8px;
    }
    .diag-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.78rem;
    }
    .diag-table th {
        text-align: left;
        color: var(--text-muted);
        padding: 4px 12px 4px 0;
        border-bottom: 1px solid var(--border);
    }
    .diag-table td {
        padding: 4px 12px 4px 0;
        color: var(--text);
    }
    .diag-table tr.highlight td {
        background: rgba(230, 126, 34, 0.15);
        font-weight: 600;
    }
    .diag-tag {
        display: inline-block;
        padding: 1px 6px;
        border-radius: 3px;
        font-size: 0.72rem;
        margin: 0 2px;
    }
    .diag-tag.female { background: #e74c8b33; color: #e74c8b; }
    .diag-tag.male { background: #3498db33; color: #3498db; }
    .diag-tag.warn { background: #e67e2233; color: #e67e22; }

    .morph-category {
        margin-bottom: 4px;
    }
    .morph-category-header {
        font-size: 0.78rem;
        color: var(--text);
        cursor: pointer;
        padding: 4px 0;
        user-select: none;
    }
    .morph-category-header:hover { color: var(--accent); }
    .morph-category-body { display: none; }
    .morph-category.open .morph-category-body { display: block; }

    .btn-reset {
        padding: 4px 12px;
        font-size: 0.78rem;
        background: var(--bg-card);
        border: 1px solid var(--border);
        border-radius: 4px;
        color: var(--text-muted);
        cursor: pointer;
        float: right;
    }
    .btn-reset:hover { border-color: var(--accent); color: var(--text); }

    .btn-toggle {
        padding: 6px 14px;
        font-size: 0.82rem;
        background: var(--bg-card);
        border: 1px solid var(--border);
        border-radius: 4px;
        color: var(--text-muted);
        cursor: pointer;
        width: 100%;
        transition: all 0.2s;
    }
    .btn-toggle:hover { border-color: var(--accent); color: var(--text); }
    .btn-toggle.active {
        background: var(--accent);
        color: #fff;
        border-color: var(--accent);
    }
</style>
{% endblock %}

{% block content %}
<div id="test-version-banner" style="
    display:none; position:fixed; top:0; left:var(--sidebar-width,220px); right:0;
    z-index:100; padding:6px 16px; background:#e67e22; color:#fff;
    font-size:0.82rem; text-align:center; font-weight:600;
">Test Charakter — Version wird geladen...</div>
<div class="viewer-container">
    <div class="canvas-wrap">
        <canvas id="viewer-canvas"></canvas>
        <div class="viewer-buttons-left">
            <button id="show-code-btn" class="viewer-btn" title="Source Code anzeigen"><i class="fas fa-code"></i> Code</button>
            <button id="play-demo-anim" class="viewer-btn" title="Play Animation"><i class="fas fa-play"></i></button>
            <button id="load-preset-btn" class="viewer-btn" title="Preset-JSON laden"><i class="fas fa-folder-open"></i> Laden</button>
            <input type="file" id="load-preset-file" accept=".json" style="display:none">
            <button id="save-model-btn" class="viewer-btn" title="Modell speichern"><i class="fas fa-save"></i> Speichern</button>
            <button id="save-model-as-btn" class="viewer-btn" title="Modell speichern unter..."><i class="fas fa-file-export"></i> Speichern unter</button>
        </div>
        <div class="viewer-buttons">
            <button id="model-toggle" class="viewer-btn active" title="Modell ein/ausblenden"><i class="fas fa-user"></i> Model</button>
            <button id="clothes-toggle" class="viewer-btn active" title="Kleider ein/ausblenden"><i class="fas fa-tshirt"></i> Kleider</button>
            <button id="rig-toggle" class="viewer-btn" title="Rig ein/ausblenden"><i class="fas fa-bone"></i> Rig</button>
        </div>
    </div>

    <div class="viewer-panel">
        <!-- Body Type -->
        <div class="panel-section" data-panel-key="body_type">
            <h3>Body Type <span class="chevron">&#9660;</span></h3>
            <div class="panel-body">
                <select id="body-type-select" class="viewer-select"></select>
                <div class="slider-row">
                    <label>Gender</label>
                    <input type="range" id="gender-slider" min="0" max="100" value="0" step="1">
                    <span class="slider-val" id="gender-val">0</span>
                </div>
                <div class="slider-row">
                    <label>Age</label>
                    <input type="range" id="meta-age" min="18" max="100" value="59" step="1">
                    <span class="slider-val" id="meta-age-val">59</span>
                </div>
                <div class="slider-row">
                    <label>Mass</label>
                    <input type="range" id="meta-mass" min="45" max="200" value="123" step="1">
                    <span class="slider-val" id="meta-mass-val">123</span>
                </div>
                <div class="slider-row">
                    <label>Tone</label>
                    <input type="range" id="meta-tone" min="0" max="100" value="50" step="1">
                    <span class="slider-val" id="meta-tone-val">50</span>
                </div>
                <div class="slider-row">
                    <label>Height</label>
                    <input type="range" id="meta-height" min="150" max="200" value="175" step="1">
                    <span class="slider-val" id="meta-height-val">175</span>
                </div>
                <div style="margin-top:8px; border-top:1px solid var(--border); padding-top:8px;">
                    <div class="slider-row">
                        <label>Skin</label>
                        <input type="color" id="skin-color-viewer" value="#d4a574" style="width:40px;height:24px;border:none;cursor:pointer;">
                    </div>
                    <div class="slider-row">
                        <label>Roughness</label>
                        <input type="range" id="skin-roughness-viewer" min="0" max="100" value="55" step="1">
                        <span class="slider-val" id="skin-roughness-viewer-val">0.55</span>
                    </div>
                    <div class="slider-row">
                        <label>Metalness</label>
                        <input type="range" id="skin-metalness-viewer" min="0" max="100" value="0" step="1">
                        <span class="slider-val" id="skin-metalness-viewer-val">0.00</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Morphs -->
        <div class="panel-section" data-panel-key="morphs">
            <h3>Morphs <button class="btn-reset" id="reset-morphs">Reset</button> <span class="chevron">&#9660;</span></h3>
            <div class="panel-body" id="morphs-panel"></div>
        </div>

        <!-- Cloth - from Template -->
        <div class="panel-section" data-panel-key="cloth_template">
            <h3>Cloth - from Template <span class="chevron">&#9660;</span></h3>
            <div class="panel-body" id="cloth-template-panel">
                <div class="slider-row"><label>Template</label>
                    <select id="cloth-tpl-type" class="viewer-select" style="margin-bottom:0;flex:1;"></select>
                </div>
                <div class="slider-row" style="gap:4px;">
                    <label>Preset</label>
                    <select id="cloth-tpl-preset" class="viewer-select" style="margin-bottom:0;flex:1;">
                        <option value="">-- none --</option>
                    </select>
                    <button id="cloth-tpl-preset-load" class="btn-toggle" style="flex:0 0 auto;padding:6px 10px;width:auto;" title="Preset laden">
                        <i class="fas fa-folder-open"></i>
                    </button>
                    <button id="cloth-tpl-preset-save" class="btn-toggle" style="flex:0 0 auto;padding:6px 10px;width:auto;" title="Preset speichern">
                        <i class="fas fa-save"></i>
                    </button>
                    <button id="cloth-tpl-preset-saveas" class="btn-toggle" style="flex:0 0 auto;padding:6px 10px;width:auto;" title="Preset speichern unter...">
                        <i class="fas fa-file-export"></i>
                    </button>
                </div>
                <div class="slider-row"><label>Segments</label>
                    <input type="range" id="cloth-tpl-segments" min="16" max="64" value="32" step="2">
                    <span class="slider-val" id="cloth-tpl-segments-val">32</span>
                </div>
                <div class="slider-row"><label>Tightness</label>
                    <input type="range" id="cloth-tpl-tightness" min="0" max="100" value="50" step="1">
                    <span class="slider-val" id="cloth-tpl-tightness-val">0.50</span>
                </div>
                <div class="slider-row"><label>Top</label>
                    <input type="range" id="cloth-tpl-top-ext" min="-30" max="30" value="0" step="1">
                    <span class="slider-val" id="cloth-tpl-top-ext-val">0 m</span>
                </div>
                <div class="slider-row"><label>Bottom</label>
                    <input type="range" id="cloth-tpl-bot-ext" min="-30" max="50" value="0" step="1">
                    <span class="slider-val" id="cloth-tpl-bot-ext-val">0 m</span>
                </div>
                <div class="slider-row"><label>Color</label>
                    <input type="color" id="cloth-color" value="#404870" style="width:40px;height:24px;border:none;cursor:pointer;">
                </div>
                <div style="display:flex;gap:6px;margin-top:6px;">
                    <button id="cloth-tpl-create" class="btn-toggle" style="flex:1;"><i class="fas fa-plus"></i> Create</button>
                    <button id="cloth-tpl-update" class="btn-toggle" style="flex:1;"><i class="fas fa-sync-alt"></i> Update</button>
                    <button id="cloth-tpl-delete" class="btn-toggle" style="flex:0 0 auto;padding:6px 10px;" title="Aktuelles Template löschen"><i class="fas fa-times"></i></button>
                    <button id="cloth-remove-all" class="btn-toggle" style="flex:0 0 auto;padding:6px 10px;" title="Alle Cloth löschen"><i class="fas fa-trash"></i></button>
                </div>
            </div>
        </div>

        <!-- Cloth Builder -->
        <div class="panel-section collapsed" data-panel-key="cloth_builder">
            <h3>Cloth Builder <span class="chevron">&#9660;</span></h3>
            <div class="panel-body" id="cloth-builder-panel">
                <div class="slider-row"><label>Region</label>
                    <select id="cloth-bld-region" class="viewer-select" style="margin-bottom:0;flex:1;"></select>
                </div>
                <div class="slider-row"><label>Looseness</label>
                    <input type="range" id="cloth-bld-looseness" min="0" max="200" value="30" step="5">
                    <span class="slider-val" id="cloth-bld-looseness-val">0.30</span>
                </div>
                <div style="margin-top:6px;">
                    <button id="cloth-bld-create" class="btn-toggle" style="width:100%;"><i class="fas fa-plus"></i> Create Garment</button>
                </div>
            </div>
        </div>

        <!-- Cloth Primitive -->
        <div class="panel-section collapsed" data-panel-key="cloth_primitive">
            <h3>Cloth - Primitive <span class="chevron">&#9660;</span></h3>
            <div class="panel-body" id="cloth-prim-panel">
                <div class="slider-row"><label>Primitive</label>
                    <select id="cloth-prim-type" class="viewer-select" style="margin-bottom:0;flex:1;"></select>
                </div>
                <div class="slider-row"><label>Segments</label>
                    <input type="range" id="cloth-prim-segments" min="12" max="64" value="32" step="2">
                    <span class="slider-val" id="cloth-prim-segments-val">32</span>
                </div>
                <div class="slider-row"><label>Length</label>
                    <input type="range" id="cloth-prim-length" min="10" max="150" value="50" step="5">
                    <span class="slider-val" id="cloth-prim-length-val">0.50</span>
                </div>
                <div class="slider-row" id="cloth-prim-flare-row"><label>Flare</label>
                    <input type="range" id="cloth-prim-flare" min="0" max="200" value="30" step="5">
                    <span class="slider-val" id="cloth-prim-flare-val">0.30</span>
                </div>
                <div style="margin-top:6px;">
                    <button id="cloth-prim-create" class="btn-toggle" style="width:100%;"><i class="fas fa-plus"></i> Create Primitive</button>
                </div>
            </div>
        </div>

        <!-- Hair -->
        <div class="panel-section collapsed" data-panel-key="hair">
            <h3>Hair <span class="chevron">&#9660;</span></h3>
            <div class="panel-body" id="hair-panel">
                <select id="hair-style-select" class="viewer-select">
                    <option value="">— No Hair —</option>
                </select>
                <div class="slider-row">
                    <label>Color</label>
                    <select id="hair-color-select" class="viewer-select" style="margin-bottom:0;"></select>
                </div>
            </div>
        </div>

        <!-- Wardrobe -->
        <div class="panel-section collapsed" data-panel-key="wardrobe">
            <h3>Wardrobe <span class="chevron">&#9660;</span></h3>
            <div class="panel-body" id="wardrobe-panel"></div>
        </div>

        <!-- Animations -->
        <div class="panel-section collapsed" data-panel-key="animations">
            <h3>Animations <span class="chevron">&#9660;</span></h3>
            <div class="panel-body" id="animation-panel">
                <div class="anim-tree" id="anim-tree">
                    <div style="padding:12px;color:var(--text-muted);font-size:0.8rem;">Lade Animationen...</div>
                </div>
                <div class="anim-speed">
                    <label id="speed-label">Speed: 1.0x</label>
                    <input type="range" id="anim-speed" min="10" max="300" value="100" step="10">
                </div>
                <div class="anim-controls">
                    <button id="anim-play" title="Play / Pause"><i class="fas fa-play"></i></button>
                    <button id="anim-stop" title="Stop"><i class="fas fa-stop"></i></button>
                    <input type="range" id="anim-timeline" min="0" max="100" value="0" step="1">
                </div>
                <div class="anim-info" id="anim-info">&mdash;</div>
            </div>
        </div>

        <!-- Status -->
        <div class="status-bar">
            WebSocket: <span id="ws-status" class="disconnected">Disconnected</span>
            &nbsp;|&nbsp; <span id="vertex-count">—</span> vertices
            &nbsp;|&nbsp; <span id="fps-display">—</span> fps
        </div>
    </div>
</div>

<!-- Code Viewer Overlay -->
<div id="code-overlay">
    <div id="code-overlay-header">
        <h2><i class="fas fa-code"></i> Source Code — humanbody_core</h2>
        <button id="code-overlay-close"><i class="fas fa-times"></i> Schliessen</button>
    </div>
    <div class="code-tabs" id="code-tabs"></div>
    <div class="code-content" id="code-content">
        <div style="padding:24px;color:var(--text-muted);">Lade Source Code...</div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.9.0/build/styles/atom-one-dark.min.css">
<script src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.9.0/build/highlight.min.js"></script>
<script src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.9.0/build/languages/python.min.js"></script>
<script>
window.VIEWER_CONFIG = {
    apiPrefix: '/api/character-test',
    wsPath: '/ws/character-test/',
    defaultBodyType: 'Caucasian',  // CharMorphPlugin: 'Caucasian', humanbody_core: 'Male_Caucasian'
};
</script>
<script type="importmap">
{
    "imports": {
        "three": "https://cdn.jsdelivr.net/npm/three@0.170.0/build/three.module.js",
        "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.170.0/examples/jsm/",
        "three-subdivide": "https://cdn.jsdelivr.net/npm/three-subdivide@1.1.5/build/index.module.js"
    }
}
</script>
<script type="module" src="{% static 'viewer/viewer.js' %}?v=24"></script>
<script>
(function() {
    const banner = document.getElementById('test-version-banner');
    if (!banner) return;
    fetch('/api/character-test/version/')
        .then(r => r.ok ? r.json() : null)
        .then(d => {
            if (d && d.short_hash) {
                const ver = d.version ? ' (v' + d.version + ')' : '';
                banner.textContent = 'Test Charakter \u2014 ' + d.short_hash + ver +
                    ' \u2014 ' + d.message + ' (' + d.date.split(' ')[0] + ')';
                banner.style.display = 'block';
            }
        })
        .catch(() => {});
})();
</script>
<script>
(function() {
    const overlay = document.getElementById('code-overlay');
    const showBtn = document.getElementById('show-code-btn');
    const closeBtn = document.getElementById('code-overlay-close');
    const tabsEl = document.getElementById('code-tabs');
    const contentEl = document.getElementById('code-content');
    let sourceData = null;

    showBtn.addEventListener('click', () => {
        overlay.classList.add('open');
        if (!sourceData) loadSource();
    });
    closeBtn.addEventListener('click', () => overlay.classList.remove('open'));
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') overlay.classList.remove('open');
    });

    function formatBytes(b) {
        if (b < 1024) return b + ' B';
        return (b / 1024).toFixed(1) + ' KB';
    }

    function loadSource() {
        contentEl.innerHTML = '<div style="padding:24px;color:var(--text-muted);">Lade Source Code...</div>';
        fetch('/api/character-test/source/')
            .then(r => r.ok ? r.json() : Promise.reject('Not found'))
            .then(data => {
                sourceData = data;
                renderTabs(data);
            })
            .catch(err => {
                contentEl.innerHTML = '<div style="padding:24px;color:#e74c3c;">Fehler: ' + err + '</div>';
            });
    }

    function renderTabs(data) {
        tabsEl.innerHTML = '';
        // Diagnostics tab first
        const diagTab = document.createElement('div');
        diagTab.className = 'code-tab active';
        diagTab.textContent = 'Data Diagnostics';
        diagTab.onclick = () => selectTab(diagTab, () => renderDiagnostics(data.data_diagnostics));
        tabsEl.appendChild(diagTab);

        // CharMorphPlugin tabs (reference implementation)
        if (data.charmorph_files && data.charmorph_files.length) {
            const cmOrder = ['morpher_cores.py', 'morphs.py', 'charlib.py'];
            const sorted = data.charmorph_files.sort((a, b) => {
                const ia = cmOrder.indexOf(a.name);
                const ib = cmOrder.indexOf(b.name);
                return (ia < 0 ? 99 : ia) - (ib < 0 ? 99 : ib);
            });
            sorted.forEach(f => {
                const tab = document.createElement('div');
                tab.className = 'code-tab';
                tab.textContent = 'CM: ' + f.name;
                tab.style.color = '#e67e22';
                tab.onclick = () => selectTab(tab, () => renderFile(f, 'CharMorphPlugin'));
                tabsEl.appendChild(tab);
            });
        }

        // humanbody_core tabs (separator)
        const sep = document.createElement('div');
        sep.style.cssText = 'border-left:1px solid var(--border);margin:0 4px;';
        tabsEl.appendChild(sep);

        const fileOrder = ['character.py', 'morphing.py', '__init__.py', 'config.py', 'mesh.py'];
        const sortedFiles = data.files.sort((a, b) => {
            const ia = fileOrder.indexOf(a.name);
            const ib = fileOrder.indexOf(b.name);
            return (ia < 0 ? 99 : ia) - (ib < 0 ? 99 : ib);
        });
        sortedFiles.forEach(f => {
            const tab = document.createElement('div');
            tab.className = 'code-tab';
            tab.textContent = f.name;
            tab.onclick = () => selectTab(tab, () => renderFile(f, 'humanbody_core'));
            tabsEl.appendChild(tab);
        });

        // Show diagnostics by default
        renderDiagnostics(data.data_diagnostics);
    }

    function selectTab(tab, renderFn) {
        tabsEl.querySelectorAll('.code-tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        renderFn();
    }

    function renderFile(f, source) {
        contentEl.innerHTML = '';
        // Header bar
        const hdr = document.createElement('div');
        hdr.style.cssText = 'padding:8px 16px;background:var(--bg-secondary);border-bottom:1px solid var(--border);font-size:0.82rem;';
        if (source === 'CharMorphPlugin') {
            hdr.innerHTML = '<span style="color:#e67e22;font-weight:600;">CharMorphPlugin</span> (Original, git 69e914e) &mdash; <code>' + f.name + '</code>';
        } else {
            hdr.innerHTML = '<span style="color:var(--accent);font-weight:600;">humanbody_core</span> (TestCharakter) &mdash; <code>' + f.name + '</code>';
        }
        contentEl.appendChild(hdr);
        const pre = document.createElement('pre');
        const code = document.createElement('code');
        code.className = 'language-python';
        code.textContent = f.content;
        pre.appendChild(code);
        contentEl.appendChild(pre);
        if (window.hljs) hljs.highlightElement(code);
    }

    function renderDiagnostics(diag) {
        let html = '';

        // L1 Body Types
        html += '<div class="diag-section"><h3>L1 Body Types (Basis-Meshes)</h3>';
        if (diag.l1 && diag.l1.length) {
            html += '<table class="diag-table"><tr><th>Name</th><th>Vertices</th><th>Shape</th><th>Size</th><th>Dtype</th></tr>';
            diag.l1.forEach(l => {
                const isMale = l.name.startsWith('Male_');
                const isCauc = l.name === 'Male_Caucasian';
                const cls = isCauc ? ' class="highlight"' : '';
                const tag = isMale
                    ? '<span class="diag-tag male">Male</span>'
                    : '<span class="diag-tag female">Female</span>';
                html += '<tr' + cls + '><td>' + tag + ' ' + l.name + '</td>';
                if (l.error) {
                    html += '<td colspan="4" style="color:#e74c3c;">' + l.error + '</td>';
                } else {
                    html += '<td>' + l.vertex_count.toLocaleString() + '</td>';
                    html += '<td>[' + l.shape.join(', ') + ']</td>';
                    html += '<td>' + formatBytes(l.size_bytes) + '</td>';
                    html += '<td>' + l.dtype + '</td>';
                }
                html += '</tr>';
            });
            html += '</table>';

            // Check for vertex count mismatch
            const counts = new Set(diag.l1.filter(l => !l.error).map(l => l.vertex_count));
            if (counts.size > 1) {
                html += '<p style="margin-top:8px;"><span class="diag-tag warn">WARNUNG</span> '
                    + 'Unterschiedliche Vertex-Counts: ' + [...counts].join(' vs ') + '. '
                    + 'Male und Female haben verschiedene Topologien!</p>';
            }
        } else {
            html += '<p style="color:var(--text-muted);">Keine L1 Dateien gefunden.</p>';
        }
        html += '</div>';

        // Gender Delta
        html += '<div class="diag-section"><h3>Gender Delta</h3>';
        if (diag.gender_delta) {
            const gd = diag.gender_delta;
            html += '<table class="diag-table"><tr><th>File</th><th>Vertices</th><th>Shape</th><th>Size</th></tr>';
            html += '<tr><td>' + gd.file + '</td>';
            html += '<td>' + gd.vertex_count.toLocaleString() + '</td>';
            html += '<td>[' + gd.shape.join(', ') + ']</td>';
            html += '<td>' + formatBytes(gd.size_bytes) + '</td></tr></table>';

            // Check if gender delta matches L1 counts
            if (diag.l1 && diag.l1.length) {
                const maleCounts = diag.l1.filter(l => l.name.startsWith('Male_') && !l.error).map(l => l.vertex_count);
                const femaleCounts = diag.l1.filter(l => l.name.startsWith('Female_') && !l.error).map(l => l.vertex_count);
                if (maleCounts.length && maleCounts[0] !== gd.vertex_count) {
                    html += '<p><span class="diag-tag warn">PROBLEM</span> '
                        + 'gender_male.npy hat ' + gd.vertex_count.toLocaleString() + ' vertices, '
                        + 'aber Male L1 hat ' + maleCounts[0].toLocaleString() + '. '
                        + 'Das Gender-Delta kann nicht auf Male-Meshes angewendet werden!</p>';
                }
                if (femaleCounts.length && femaleCounts[0] === gd.vertex_count) {
                    html += '<p><span class="diag-tag female">INFO</span> '
                        + 'gender_male.npy passt zu Female-Topologie (' + gd.vertex_count.toLocaleString() + ' verts). '
                        + 'Es ist als Delta auf Female gedacht, nicht auf Male.</p>';
                }
            }
        } else {
            html += '<p style="color:var(--text-muted);">Kein gender_male.npy vorhanden.</p>';
        }
        html += '</div>';

        // L2 Packed Morphs
        html += '<div class="diag-section"><h3>L2 Packed Morphs</h3>';
        if (diag.l2_packed && diag.l2_packed.length) {
            diag.l2_packed.forEach(p => {
                html += '<div style="margin-bottom:8px;">';
                html += '<strong>' + p.file + '</strong>';
                if (p.error) {
                    html += ' <span style="color:#e74c3c;">' + p.error + '</span>';
                } else {
                    html += ' — ' + p.morph_count + ' Morphs, ' + formatBytes(p.size_bytes);
                    html += '<br><span style="font-size:0.72rem;color:var(--text-muted);">'
                        + p.morph_names.join(', ')
                        + (p.morph_count > 20 ? ', ...' : '')
                        + '</span>';
                }
                html += '</div>';
            });
        } else {
            html += '<p style="color:var(--text-muted);">Keine L2 Packs gefunden.</p>';
        }
        html += '</div>';

        // Data Files
        html += '<div class="diag-section"><h3>Data Files</h3>';
        if (diag.data_files && diag.data_files.length) {
            html += '<table class="diag-table"><tr><th>File</th><th>Size</th></tr>';
            diag.data_files.forEach(f => {
                html += '<tr><td>' + f.name + '</td><td>' + formatBytes(f.size_bytes) + '</td></tr>';
            });
            html += '</table>';
        }
        html += '</div>';

        // Code Flow Explanation
        html += '<div class="diag-section"><h3>Code-Flow: Male_Caucasian</h3>';
        html += '<div style="font-size:0.82rem;line-height:1.6;color:var(--text);">';
        html += '<ol style="padding-left:20px;">';
        html += '<li><code>MorphData.load()</code> — Liest alle L1/*.npy Dateien. Male_Caucasian.npy wird als Basis geladen.</li>';
        html += '<li><code>CharacterState.set_body_type("Male_Caucasian")</code> — Setzt <code>self._basis = l1["Male_Caucasian"]</code></li>';
        html += '<li><code>get_l2_for_type("Male_Caucasian")</code> — Lädt L2_packed/__main__.npz + L2_packed/Caucasian.npz</li>';
        html += '<li><code>compute()</code> — Startet mit <code>self._basis.copy()</code> (Male_Caucasian L1)</li>';
        html += '<li><strong>Gender Delta</strong> — <code>gender_male.npy</code> wird addiert wenn <code>self.gender > 0</code>.<br>';
        html += '<span class="diag-tag warn">PROBLEM</span> Wenn gender_male.npy eine andere Vertex-Anzahl hat als Male L1, crasht es oder erzeugt Mist!</li>';
        html += '<li><strong>L2 Morphs</strong> — Alle Slider-Deltas werden auf die Vertices addiert.</li>';
        html += '</ol>';
        html += '</div></div>';

        contentEl.innerHTML = html;
    }
})();
</script>
{% endblock %}
