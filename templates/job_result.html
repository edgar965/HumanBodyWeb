{% extends "base.html" %}
{% load static %}
{% block title %}{{ job.name }} - Result{% endblock %}

{% block extra_head %}
<script type="importmap">
{
  "imports": {
    "three": "https://cdn.jsdelivr.net/npm/three@0.170.0/build/three.module.js",
    "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.170.0/examples/jsm/"
  }
}
</script>
{% endblock %}

{% block content %}
<div class="result-header">
    <h1>{{ job.name }}</h1>
    <div class="result-header-actions">
        <a href="{% url 'job_status' job.id %}" class="btn btn-secondary btn-sm">
            <i class="fas fa-arrow-left"></i> Back
        </a>
        {% if job.bvh_file %}
        <a href="{% url 'serve_bvh' job.id %}" class="btn btn-primary btn-sm" download title="Download BVH">
            <i class="fas fa-download"></i> BVH
        </a>
        {% endif %}
        {% if job.status == 'complete' %}
        <a href="{% url 'save_overlay_video' job.id %}" class="btn btn-secondary btn-sm" download title="Download Video + Skeleton">
            <i class="fas fa-download"></i> Video + Skeleton
        </a>
        <a href="{% url 'save_rig_video' job.id %}" class="btn btn-secondary btn-sm" download title="Download Nur Skeleton">
            <i class="fas fa-download"></i> Nur Skeleton
        </a>
        {% if job.bvh_file %}
        <button class="btn btn-secondary btn-sm" id="btnVideo3D" title="Record 3D Character Animation as Video">
            <i class="fas fa-cube"></i> Video3D
        </button>
        {% endif %}
        {% endif %}
    </div>
</div>

<div class="result-layout">
    <div class="result-panel">
        <div class="panel-label"><i class="fas fa-video"></i> Video + Skeleton Overlay</div>
        <div class="video-overlay-wrapper">
            <video id="resultVideo" preload="auto" muted>
                <source src="{{ job.video_file.url }}" type="video/mp4">
            </video>
            <div id="skeletonOverlay" class="skeleton-overlay"></div>
        </div>
    </div>
    <div class="result-panel">
        <div class="panel-label"><i class="fas fa-bone"></i> 3D Skeleton</div>
        <div id="skeletonCanvas"></div>
    </div>
</div>

<div class="player-controls">
    <div class="controls-row controls-buttons">
        <button class="ctrl-btn" id="btnSkipBack10" title="Back 10s"><i class="fas fa-backward"></i> 10s</button>
        <button class="ctrl-btn" id="btnSkipBack1" title="Back 1s"><i class="fas fa-backward-step"></i> 1s</button>
        <button class="ctrl-btn" id="btnFrameBack" title="Previous frame"><i class="fas fa-caret-left"></i> F</button>
        <button class="ctrl-btn ctrl-btn-play" id="btnPlayPause" title="Play/Pause"><i class="fas fa-play" id="playIcon"></i></button>
        <button class="ctrl-btn" id="btnFrameFwd" title="Next frame">F <i class="fas fa-caret-right"></i></button>
        <button class="ctrl-btn" id="btnSkipFwd1" title="Forward 1s">1s <i class="fas fa-forward-step"></i></button>
        <button class="ctrl-btn" id="btnSkipFwd10" title="Forward 10s">10s <i class="fas fa-forward"></i></button>
    </div>
    <div class="controls-row controls-timeline">
        <span class="time-display" id="timeCurrent">00:00</span>
        <input type="range" class="timeline-slider" id="timelineSlider" min="0" max="100" step="0.01" value="0">
        <span class="time-display" id="timeDuration">00:00</span>
    </div>
    <div class="controls-row controls-speed">
        <span class="speed-label">Speed:</span>
        <button class="speed-btn" data-speed="0.25">0.25x</button>
        <button class="speed-btn" data-speed="0.5">0.5x</button>
        <button class="speed-btn active" data-speed="1">1x</button>
        <button class="speed-btn" data-speed="2">2x</button>
        <span style="margin-left:auto;color:#666;font-size:0.75rem;">
            <kbd style="background:#333;padding:2px 6px;border-radius:3px;">Space</kbd> Play/Pause
            <kbd style="background:#333;padding:2px 6px;border-radius:3px;margin-left:6px;">&larr;&rarr;</kbd> Frame
        </span>
    </div>
</div>

{% if job.bvh_file %}
<div class="result-character">
    <div class="panel-label"><i class="fas fa-user"></i> 3D Character</div>
    <div class="result-character-controls">
        <label>Body Type:</label>
        <select id="resultBodyType" class="result-body-select"></select>
        <button class="btn btn-sm btn-secondary" id="btnToggleHair" style="margin-left:auto;padding:0.15rem 0.5rem;font-size:0.75rem;">
            <i class="fas fa-hat-wizard"></i> Hair
        </button>
        <label class="result-checkbox">
            <input type="checkbox" id="ignoreFaceBones"> Ignore Face Bones
        </label>
    </div>
    <div class="result-character-body">
        <div class="result-character-viewport">
            <canvas id="characterCanvas"></canvas>
            <div id="characterLoading" class="character-loading">
                <i class="fas fa-spinner fa-spin"></i> Lade 3D Character...
            </div>
        </div>
        <div class="result-character-panel" id="characterPanel"></div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block extra_scripts %}
<script type="module">
try {
    const { initBVHPlayer } = await import('{% static "js/bvh_player.js" %}?v=077');
    initBVHPlayer({
        videoId: 'resultVideo',
        canvasId: 'skeletonCanvas',
        bvhUrl: '{% url "serve_bvh" job.id %}',
        fps: {{ job.fps|default:"30" }},
        overlayId: 'skeletonOverlay',
        detectionUrl: '{% url "serve_detection" job.id %}',
        keypointsUrl: '{% url "serve_keypoints" job.id %}',
    });
} catch(e) {
    console.error('[bvh_player] Init error:', e);
    const err = document.createElement('div');
    err.style.cssText = 'position:fixed;top:0;left:0;right:0;background:#c0392b;color:white;padding:1rem;z-index:99999;font-size:14px;display:flex;justify-content:space-between;align-items:center;';
    err.innerHTML = '<span>JS Error: ' + e.message + '</span><button onclick="this.parentElement.remove()" style="background:none;border:1px solid white;color:white;padding:4px 12px;cursor:pointer;border-radius:4px;">X</button>';
    document.body.appendChild(err);
}
</script>
{% if job.bvh_file %}
<script type="module">
try {
    const { initResultCharacter } = await import('{% static "viewer/result_character.js" %}?v=8');
    initResultCharacter({
        canvasId: 'characterCanvas',
        videoId: 'resultVideo',
        bvhUrl: '{% url "serve_bvh" job.id %}',
        panelId: 'characterPanel',
        bodyTypeSelectId: 'resultBodyType',
    });
} catch(e) {
    console.error('[result_character] Init error:', e);
}

// --- Video3D recording ---
const btn3d = document.getElementById('btnVideo3D');
if (btn3d) {
    btn3d.addEventListener('click', () => recordVideo3D());
}

async function recordVideo3D() {
    const canvas = document.getElementById('characterCanvas');
    const video = document.getElementById('resultVideo');
    const btn = document.getElementById('btnVideo3D');
    if (!canvas || !video) return;

    const fps = {{ job.fps|default:"30" }};
    const origText = btn.innerHTML;

    // Create progress bar overlay on the character viewport
    const viewport = canvas.parentElement;
    const progressBar = document.createElement('div');
    progressBar.style.cssText = 'position:absolute;bottom:0;left:0;right:0;height:32px;background:rgba(0,0,0,0.7);display:flex;align-items:center;padding:0 10px;gap:8px;z-index:10;font-size:0.8rem;color:#fff;';
    const progressTrack = document.createElement('div');
    progressTrack.style.cssText = 'flex:1;height:6px;background:rgba(255,255,255,0.15);border-radius:3px;overflow:hidden;';
    const progressFill = document.createElement('div');
    progressFill.style.cssText = 'height:100%;width:0%;background:#e74c3c;border-radius:3px;transition:width 0.1s;';
    progressTrack.appendChild(progressFill);
    const progressLabel = document.createElement('span');
    progressLabel.textContent = '0%';
    progressLabel.style.cssText = 'min-width:36px;text-align:right;';
    const recDot = document.createElement('span');
    recDot.style.cssText = 'width:8px;height:8px;border-radius:50%;background:#e74c3c;animation:recPulse 1s infinite;';
    // Add pulse animation
    if (!document.getElementById('recPulseStyle')) {
        const style = document.createElement('style');
        style.id = 'recPulseStyle';
        style.textContent = '@keyframes recPulse{0%,100%{opacity:1}50%{opacity:0.3}}';
        document.head.appendChild(style);
    }
    progressBar.append(recDot, progressTrack, progressLabel);
    viewport.style.position = 'relative';
    viewport.appendChild(progressBar);

    // Disable button, show recording state
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-circle" style="color:#e74c3c"></i> Aufnahme...';

    // Pause and seek to start
    video.pause();
    video.currentTime = 0;
    await new Promise(r => { video.onseeked = r; });

    // Wait for the 3D scene to update
    await new Promise(r => requestAnimationFrame(r));
    await new Promise(r => requestAnimationFrame(r));

    // Start recording the canvas
    const stream = canvas.captureStream(fps);
    const chunks = [];
    const mimeType = MediaRecorder.isTypeSupported('video/webm;codecs=vp9')
        ? 'video/webm;codecs=vp9'
        : 'video/webm';
    const recorder = new MediaRecorder(stream, { mimeType, videoBitsPerSecond: 8_000_000 });
    recorder.ondataavailable = (e) => { if (e.data.size > 0) chunks.push(e.data); };

    const recordingDone = new Promise(resolve => {
        recorder.onstop = resolve;
    });

    // Update progress bar during playback
    let progressRAF;
    function updateProgress() {
        if (video.duration > 0) {
            const pct = Math.min(100, (video.currentTime / video.duration) * 100);
            progressFill.style.width = pct + '%';
            progressLabel.textContent = Math.round(pct) + '%';
        }
        progressRAF = requestAnimationFrame(updateProgress);
    }

    recorder.start();
    video.play();
    updateProgress();

    await new Promise(resolve => {
        video.onended = resolve;
        video.onpause = () => {
            if (video.currentTime < video.duration - 0.5) {
                recorder.stop();
                resolve();
            }
        };
    });

    cancelAnimationFrame(progressRAF);
    progressFill.style.width = '100%';
    progressLabel.textContent = '100%';

    // Stop recording if still active
    if (recorder.state === 'recording') {
        recorder.stop();
    }

    await recordingDone;

    // Create blob and save to server + download
    const blob = new Blob(chunks, { type: mimeType });

    // Upload to server (save to video_output_dir)
    const formData = new FormData();
    formData.append('video', blob, '{{ job.name }}_3d_character.webm');
    try {
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value
            || document.cookie.match(/csrftoken=([^;]+)/)?.[1] || '';
        const resp = await fetch('{% url "save_video3d" job.id %}', {
            method: 'POST',
            headers: { 'X-CSRFToken': csrfToken },
            body: formData,
        });
        const data = await resp.json();
        if (data.ok) {
            progressLabel.textContent = 'Saved!';
        }
    } catch(err) {
        console.warn('Video3D upload failed:', err);
    }

    // Also trigger browser download
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = '{{ job.name }}_3d_character.webm';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);

    // Cleanup
    await new Promise(r => setTimeout(r, 1500));
    progressBar.remove();
    btn.disabled = false;
    btn.innerHTML = origText;
    video.pause();
}
</script>
{% endif %}
{% endblock %}
