{% extends "base.html" %}
{% load static %}
{% block title %}{{ job.name }} - Result{% endblock %}

{% block extra_head %}
<script type="importmap">
{
  "imports": {
    "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
    "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/"
  }
}
</script>
{% endblock %}

{% block content %}
<div class="result-header">
    <h1>{{ job.name }}</h1>
    <div class="result-header-actions">
        <a href="{% url 'job_status' job.id %}" class="btn btn-secondary btn-sm">
            <i class="fas fa-arrow-left"></i> Back
        </a>
        {% if job.bvh_file %}
        <a href="{% url 'serve_bvh' job.id %}" class="btn btn-primary btn-sm" download title="Download BVH">
            <i class="fas fa-download"></i> BVH
        </a>
        {% endif %}
        {% if job.status == 'complete' %}
        <a href="{% url 'save_overlay_video' job.id %}" class="btn btn-secondary btn-sm" download title="Download Video + Skeleton">
            <i class="fas fa-download"></i> Video + Skeleton
        </a>
        <a href="{% url 'save_rig_video' job.id %}" class="btn btn-secondary btn-sm" download title="Download Nur Skeleton">
            <i class="fas fa-download"></i> Nur Skeleton
        </a>
        {% endif %}
    </div>
</div>

<div class="result-layout">
    <div class="result-panel">
        <div class="panel-label"><i class="fas fa-video"></i> Video + Skeleton Overlay</div>
        <div class="video-overlay-wrapper">
            <video id="resultVideo" preload="auto" muted>
                <source src="{{ job.video_file.url }}" type="video/mp4">
            </video>
            <div id="skeletonOverlay" class="skeleton-overlay"></div>
        </div>
    </div>
    <div class="result-panel">
        <div class="panel-label"><i class="fas fa-bone"></i> 3D Skeleton</div>
        <div id="skeletonCanvas"></div>
    </div>
</div>

<div class="player-controls">
    <div class="controls-row controls-buttons">
        <button class="ctrl-btn" id="btnSkipBack10" title="Back 10s"><i class="fas fa-backward"></i> 10s</button>
        <button class="ctrl-btn" id="btnSkipBack1" title="Back 1s"><i class="fas fa-backward-step"></i> 1s</button>
        <button class="ctrl-btn" id="btnFrameBack" title="Previous frame"><i class="fas fa-caret-left"></i> F</button>
        <button class="ctrl-btn ctrl-btn-play" id="btnPlayPause" title="Play/Pause"><i class="fas fa-play" id="playIcon"></i></button>
        <button class="ctrl-btn" id="btnFrameFwd" title="Next frame">F <i class="fas fa-caret-right"></i></button>
        <button class="ctrl-btn" id="btnSkipFwd1" title="Forward 1s">1s <i class="fas fa-forward-step"></i></button>
        <button class="ctrl-btn" id="btnSkipFwd10" title="Forward 10s">10s <i class="fas fa-forward"></i></button>
    </div>
    <div class="controls-row controls-timeline">
        <span class="time-display" id="timeCurrent">00:00</span>
        <input type="range" class="timeline-slider" id="timelineSlider" min="0" max="100" step="0.01" value="0">
        <span class="time-display" id="timeDuration">00:00</span>
    </div>
    <div class="controls-row controls-speed">
        <span class="speed-label">Speed:</span>
        <button class="speed-btn" data-speed="0.25">0.25x</button>
        <button class="speed-btn" data-speed="0.5">0.5x</button>
        <button class="speed-btn active" data-speed="1">1x</button>
        <button class="speed-btn" data-speed="2">2x</button>
        <span style="margin-left:auto;color:#666;font-size:0.75rem;">
            <kbd style="background:#333;padding:2px 6px;border-radius:3px;">Space</kbd> Play/Pause
            <kbd style="background:#333;padding:2px 6px;border-radius:3px;margin-left:6px;">&larr;&rarr;</kbd> Frame
        </span>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script type="module">
try {
    const { initBVHPlayer } = await import('{% static "js/bvh_player.js" %}?v=076');
    initBVHPlayer({
        videoId: 'resultVideo',
        canvasId: 'skeletonCanvas',
        bvhUrl: '{% url "serve_bvh" job.id %}',
        fps: {{ job.fps|default:"30" }},
        overlayId: 'skeletonOverlay',
        detectionUrl: '{% url "serve_detection" job.id %}',
        keypointsUrl: '{% url "serve_keypoints" job.id %}',
    });
} catch(e) {
    console.error('[bvh_player] Init error:', e);
    const err = document.createElement('div');
    err.style.cssText = 'position:fixed;top:0;left:0;right:0;background:#c0392b;color:white;padding:1rem;z-index:99999;font-size:14px;display:flex;justify-content:space-between;align-items:center;';
    err.innerHTML = '<span>JS Error: ' + e.message + '</span><button onclick="this.parentElement.remove()" style="background:none;border:1px solid white;color:white;padding:4px 12px;cursor:pointer;border-radius:4px;">X</button>';
    document.body.appendChild(err);
}
</script>
{% endblock %}
