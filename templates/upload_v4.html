{% extends "base.html" %}
{% block title %}3D Pipeline - HumanBody{% endblock %}

{% block content %}
<h1>3D Pipeline <small style="color:#888;">(Video &rarr; BVH)</small></h1>

<div class="upload-area" id="dropZone">
    <form method="post" enctype="multipart/form-data" id="uploadForm">
        {% csrf_token %}

        <div class="drop-zone" id="dropTarget">
            <i class="fas fa-cloud-upload-alt fa-3x"></i>
            <p>Drag & drop video here or click to browse</p>
            <input type="file" name="video" id="videoInput" accept="video/*" required>
        </div>

        <div class="form-group">
            <label>3D Pipeline:</label>
            <div class="pipeline-options">
                <label class="pipeline-option {% if not status_3d.v4 %}disabled{% endif %}">
                    <input type="radio" name="pipeline" value="v4"
                        {% if default_3d == 'v4' %}checked{% endif %}
                        {% if not status_3d.v4 %}disabled{% endif %}>
                    <span class="pipeline-label">MocapNET v4</span>
                    <span class="pipeline-desc">
                        {% if status_3d.v4 %}ONNX, CPU, 165 Bones, ~75 mm{% else %}nicht verf&uuml;gbar{% endif %}
                    </span>
                </label>
                <label class="pipeline-option {% if not status_3d.wham %}disabled{% endif %}">
                    <input type="radio" name="pipeline" value="wham"
                        {% if default_3d == 'wham' %}checked{% endif %}
                        {% if not status_3d.wham %}disabled{% endif %}>
                    <span class="pipeline-label">WHAM</span>
                    <span class="pipeline-desc">
                        {% if status_3d.wham %}SMPL, GPU, World-Koordinaten, 37 mm{% else %}nicht installiert{% endif %}
                    </span>
                </label>
                <label class="pipeline-option {% if not status_3d.prompthmr %}disabled{% endif %}">
                    <input type="radio" name="pipeline" value="prompthmr"
                        {% if default_3d == 'prompthmr' %}checked{% endif %}
                        {% if not status_3d.prompthmr %}disabled{% endif %}>
                    <span class="pipeline-label">PromptHMR</span>
                    <span class="pipeline-desc">
                        {% if status_3d.prompthmr %}SMPL, GPU, CVPR 2025, 37 mm{% else %}nicht installiert{% endif %}
                    </span>
                </label>
                <label class="pipeline-option {% if not status_3d.gvhmr %}disabled{% endif %}">
                    <input type="radio" name="pipeline" value="gvhmr"
                        {% if default_3d == 'gvhmr' %}checked{% endif %}
                        {% if not status_3d.gvhmr %}disabled{% endif %}>
                    <span class="pipeline-label">GVHMR &star;</span>
                    <span class="pipeline-desc">
                        {% if status_3d.gvhmr %}SMPL, GPU, beste Qualit&auml;t, 36 mm{% else %}nicht installiert{% endif %}
                    </span>
                </label>
            </div>
        </div>

        <div class="form-group" id="v4Parts">
            <label>Body Parts (nur MocapNET v4):</label>
            <div class="pipeline-options" style="flex-wrap:wrap;">
                <label class="pipeline-option" style="flex:0 0 auto;">
                    <input type="checkbox" name="parts" value="body" checked>
                    <span class="pipeline-label">Body</span>
                </label>
                <label class="pipeline-option" style="flex:0 0 auto;">
                    <input type="checkbox" name="parts" value="hands" checked>
                    <span class="pipeline-label">Hands</span>
                </label>
                <label class="pipeline-option" style="flex:0 0 auto;">
                    <input type="checkbox" name="parts" value="face" checked>
                    <span class="pipeline-label">Face</span>
                </label>
                <label class="pipeline-option" style="flex:0 0 auto;">
                    <input type="checkbox" name="parts" value="mouth" checked>
                    <span class="pipeline-label">Mouth</span>
                </label>
                <label class="pipeline-option" style="flex:0 0 auto;">
                    <input type="checkbox" name="parts" value="eyes" checked>
                    <span class="pipeline-label">Eyes</span>
                </label>
            </div>
        </div>

        <div class="form-group">
            <label for="fps">FPS:</label>
            <input type="number" name="fps" id="fps" value="30" min="1" max="120" step="0.1">
        </div>

        <button type="submit" class="btn btn-primary">
            <i class="fas fa-upload"></i> Upload
        </button>
    </form>
</div>

{% if v4_jobs %}
<div class="job-list-section">
    <div style="display:flex; align-items:center; gap:10px; margin-bottom:10px;">
        <h3 style="margin:0;">Uploaded Videos</h3>
        <button class="btn btn-sm btn-danger" id="bulkDeleteBtn" style="display:none;" onclick="bulkDelete()">
            <i class="fas fa-trash"></i> Delete Selected
        </button>
    </div>
    <table class="processed-table" id="jobTable">
        <thead>
            <tr>
                <th style="width:30px;"><input type="checkbox" id="selectAll" onchange="toggleSelectAll(this)"></th>
                <th class="sortable" onclick="sortTable('name')">Name <i class="fas fa-sort"></i></th>
                <th>Pipeline</th>
                <th>Status</th>
                <th class="sortable" onclick="sortTable('size')">Size <i class="fas fa-sort"></i></th>
                <th class="sortable" onclick="sortTable('date')">Created <i class="fas fa-sort"></i></th>
                <th>Process</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="jobTableBody">
            {% for job in v4_jobs %}
            <tr id="row-{{ job.id }}" data-name="{{ job.name|lower }}" data-size="{{ job.video_size }}" data-date="{{ job.created_at|date:'Y-m-d H:i:s' }}">
                <td><input type="checkbox" class="job-check" value="{{ job.id }}" onchange="updateBulkBtn()"></td>
                <td>{{ job.name }}</td>
                <td><span class="badge badge-{{ job.pipeline }}">{{ job.get_pipeline_display }}</span></td>
                <td>
                    {% if job.status == 'complete' %}
                        <span style="color:#2ecc71;"><i class="fas fa-check-circle"></i> Complete</span>
                    {% elif job.status == 'failed' %}
                        <span style="color:#e74c3c;"><i class="fas fa-times-circle"></i> Failed</span>
                    {% elif job.status == 'pending' %}
                        <span style="color:#f39c12;"><i class="fas fa-clock"></i> Pending</span>
                    {% else %}
                        <span style="color:#3498db;"><i class="fas fa-spinner fa-spin"></i> {{ job.get_status_display }}</span>
                    {% endif %}
                </td>
                <td>{{ job.video_size_display }}</td>
                <td>{{ job.created_at|date:"d.m.Y H:i" }}</td>
                <td>
                    <a class="btn btn-sm btn-primary" href="{% url 'start_processing' job.id %}">
                        <i class="fas fa-play"></i> Process
                    </a>
                </td>
                <td style="display:flex; gap:5px;">
                    {% if job.status == 'complete' %}
                    <a class="btn btn-sm btn-primary" href="{% url 'job_result' job.id %}">
                        <i class="fas fa-eye"></i> View
                    </a>
                    {% elif job.status != 'pending' %}
                    <a class="btn btn-sm btn-secondary" href="{% url 'job_status' job.id %}">
                        <i class="fas fa-info-circle"></i> Status
                    </a>
                    {% endif %}
                    <button class="btn btn-sm btn-danger" onclick="deleteJob('{{ job.id }}', this)">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endif %}

<div class="info-box">
    <h3>Vergleich 3D Pipelines</h3>
    <table class="compare-table">
        <thead>
            <tr>
                <th>Pipeline</th>
                <th>Genauigkeit</th>
                <th>Geschwindigkeit</th>
                <th>GPU VRAM</th>
                <th>RAM</th>
                <th>Empfehlung</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td><strong>MocapNET v4</strong></td>
                <td>~75 mm MPJPE*</td>
                <td>~30 FPS (CPU!)</td>
                <td>0&ndash;2 GB</td>
                <td>~2&ndash;4 GB</td>
                <td>Kein GPU n&ouml;tig, 165 Bones</td>
            </tr>
            <tr>
                <td><strong>WHAM</strong></td>
                <td>37 mm PA-MPJPE</td>
                <td>~5&ndash;8 FPS</td>
                <td>6&ndash;8 GB</td>
                <td>~8&ndash;16 GB</td>
                <td>World-Koordinaten</td>
            </tr>
            <tr>
                <td><strong>PromptHMR</strong></td>
                <td>37 mm PA-MPJPE</td>
                <td>~10&ndash;20 FPS</td>
                <td>6&ndash;8 GB</td>
                <td>~8&ndash;12 GB</td>
                <td><span style="color:#e67e22;">&starf; Beste Qualit&auml;t (per-frame)</span></td>
            </tr>
            <tr style="background:#1a2a1a;">
                <td><strong>GVHMR</strong></td>
                <td>36 mm PA-MPJPE</td>
                <td>~5&ndash;10 FPS</td>
                <td>6&ndash;8 GB</td>
                <td>~8&ndash;16 GB</td>
                <td><span style="color:#2ecc71;">&starf; Empfohlen</span></td>
            </tr>
        </tbody>
    </table>
    <p style="margin-top:8px; color:#888;">
        <small>PA-MPJPE = Procrustes-Aligned Mean Per Joint Position Error auf 3DPW (niedriger = besser).<br>
        *MocapNET v4 nutzt H3.6M und ein eigenes Skelett &mdash; nicht direkt vergleichbar mit SMPL-Methoden.<br>
        Geschwindigkeit gesch&auml;tzt f&uuml;r RTX 3060. GVHMR/WHAM/PromptHMR ben&ouml;tigen mindestens 6 GB VRAM.</small>
    </p>

    <h3 style="margin-top:1.5rem;">SMPL-Lizenz</h3>
    <p>GVHMR, WHAM und PromptHMR ben&ouml;tigen SMPL Modell-Dateien. Kostenlos beantragen: <a href="https://smpl.is.tue.mpg.de" target="_blank">smpl.is.tue.mpg.de</a></p>
</div>
{% endblock %}

{% block extra_scripts %}
<style>
.sortable { cursor: pointer; user-select: none; }
.sortable:hover { color: #3498db; }
</style>
<script>
const dropTarget = document.getElementById('dropTarget');
const videoInput = document.getElementById('videoInput');

dropTarget.addEventListener('click', () => videoInput.click());

dropTarget.addEventListener('dragover', (e) => {
    e.preventDefault();
    dropTarget.classList.add('drag-over');
});

dropTarget.addEventListener('dragleave', () => {
    dropTarget.classList.remove('drag-over');
});

dropTarget.addEventListener('drop', (e) => {
    e.preventDefault();
    dropTarget.classList.remove('drag-over');
    if (e.dataTransfer.files.length) {
        videoInput.files = e.dataTransfer.files;
        dropTarget.querySelector('p').textContent = e.dataTransfer.files[0].name;
    }
});

videoInput.addEventListener('change', () => {
    if (videoInput.files.length) {
        dropTarget.querySelector('p').textContent = videoInput.files[0].name;
    }
});

// Toggle v4 body parts visibility
document.querySelectorAll('input[name="pipeline"]').forEach(radio => {
    radio.addEventListener('change', function() {
        document.getElementById('v4Parts').style.display = this.value === 'v4' ? '' : 'none';
    });
});

function getCsrf() {
    return document.querySelector('[name=csrfmiddlewaretoken]').value;
}

function deleteJob(jobId, btn) {
    if (!confirm('Delete this job?')) return;
    fetch('/api/job/' + jobId + '/delete/', {
        method: 'POST',
        headers: {'X-CSRFToken': getCsrf()}
    }).then(r => r.json()).then(data => {
        if (data.ok) {
            var row = document.getElementById('row-' + jobId);
            if (row) row.remove();
            updateBulkBtn();
            var tbody = document.getElementById('jobTableBody');
            if (tbody && tbody.children.length === 0) {
                var section = tbody.closest('.job-list-section');
                if (section) section.style.display = 'none';
            }
        }
    });
}

function toggleSelectAll(el) {
    document.querySelectorAll('.job-check').forEach(c => c.checked = el.checked);
    updateBulkBtn();
}

function updateBulkBtn() {
    var checked = document.querySelectorAll('.job-check:checked').length;
    var btn = document.getElementById('bulkDeleteBtn');
    if (btn) btn.style.display = checked > 0 ? '' : 'none';
}

function bulkDelete() {
    var ids = Array.from(document.querySelectorAll('.job-check:checked')).map(c => c.value);
    if (!ids.length) return;
    if (!confirm('Delete ' + ids.length + ' job(s)?')) return;
    fetch('/api/jobs/bulk-delete/', {
        method: 'POST',
        headers: {'X-CSRFToken': getCsrf(), 'Content-Type': 'application/json'},
        body: JSON.stringify({ids: ids})
    }).then(r => r.json()).then(data => {
        if (data.ok) {
            data.deleted.forEach(id => {
                var row = document.getElementById('row-' + id);
                if (row) row.remove();
            });
            document.getElementById('selectAll').checked = false;
            updateBulkBtn();
            var tbody = document.getElementById('jobTableBody');
            if (tbody && tbody.children.length === 0) {
                var section = tbody.closest('.job-list-section');
                if (section) section.style.display = 'none';
            }
        }
    });
}

// Sortable table
var sortDir = {};
function sortTable(key) {
    var tbody = document.getElementById('jobTableBody');
    if (!tbody) return;
    var rows = Array.from(tbody.querySelectorAll('tr'));
    sortDir[key] = !sortDir[key];
    var asc = sortDir[key];
    rows.sort(function(a, b) {
        var va = a.dataset[key] || '';
        var vb = b.dataset[key] || '';
        if (key === 'size') {
            return asc ? (Number(va) - Number(vb)) : (Number(vb) - Number(va));
        }
        return asc ? va.localeCompare(vb) : vb.localeCompare(va);
    });
    rows.forEach(function(row) { tbody.appendChild(row); });
}
</script>
{% endblock %}
