{% extends "base.html" %}
{% block title %}Video to BVH: 3D - Einstellungen{% endblock %}

{% block content %}
<h1>Einstellungen &mdash; Video to BVH: 3D</h1>

<form method="post">
    {% csrf_token %}

    {# ── Default Pipeline ── #}
    <div class="settings-card">
        <h2><i class="fas fa-check-circle"></i> Standard-Pipeline</h2>

        <div class="settings-row">
            <div class="settings-label">
                <strong>Default 3D Pipeline</strong>
                <small>Welche Pipeline auf der 3D-Seite standardm&auml;&szlig;ig ausgew&auml;hlt ist.</small>
            </div>
            <div class="settings-input">
                <select name="lifter_3d_default" class="settings-select">
                    <option value="v4" {% if settings.lifter_3d_default == 'v4' %}selected{% endif %}>MocapNET v4 (CPU, ~75 mm)</option>
                    <option value="wham" {% if settings.lifter_3d_default == 'wham' %}selected{% endif %}>WHAM (SMPL, GPU, 37 mm)</option>
                    <option value="prompthmr" {% if settings.lifter_3d_default == 'prompthmr' %}selected{% endif %}>PromptHMR (SMPL, GPU, 37 mm)</option>
                    <option value="gvhmr" {% if settings.lifter_3d_default == 'gvhmr' %}selected{% endif %}>GVHMR (SMPL, GPU, 36 mm, empfohlen)</option>
                </select>
            </div>
        </div>
    </div>

    {# ── MocapNET v4 ── #}
    <div class="settings-card" style="margin-top:1.5rem;">
        <h2>
            <i class="fas fa-brain"></i> MocapNET v4
            <small style="color:#888;">~75 mm, CPU, 165 Bones</small>
            {% if v4_installed %}<span style="color:#27ae60;margin-left:0.5rem;" title="Installiert"><i class="fas fa-check-circle"></i></span>
            {% else %}<span style="color:#e74c3c;margin-left:0.5rem;" title="Nicht installiert"><i class="fas fa-times-circle"></i></span>{% endif %}
        </h2>

        {# Components #}
        <div class="settings-row">
            <div class="settings-label">
                <strong>Komponenten</strong>
                <small>Welche Tracking-Komponenten aktiv sind. Body sollte immer aktiviert sein.</small>
            </div>
            <div class="settings-input" style="display:flex;flex-wrap:wrap;gap:1rem;">
                <label class="settings-checkbox">
                    <input type="checkbox" name="v4_enable_body" {% if settings.v4_enable_body %}checked{% endif %}> Body
                </label>
                <label class="settings-checkbox">
                    <input type="checkbox" name="v4_enable_face" {% if settings.v4_enable_face %}checked{% endif %}> Face
                </label>
                <label class="settings-checkbox">
                    <input type="checkbox" name="v4_enable_hands" {% if settings.v4_enable_hands %}checked{% endif %}> Hands
                </label>
                <label class="settings-checkbox">
                    <input type="checkbox" name="v4_enable_mouth" {% if settings.v4_enable_mouth %}checked{% endif %}> Mouth
                </label>
                <label class="settings-checkbox">
                    <input type="checkbox" name="v4_enable_eyes" {% if settings.v4_enable_eyes %}checked{% endif %}> Eyes
                </label>
            </div>
        </div>

        {# IK Solver #}
        <div class="settings-row">
            <div class="settings-label">
                <strong>HCD Iterations</strong>
                <small>IK Gradient-Descent Iterationen pro Frame. Mehr = genauer aber langsamer.</small>
            </div>
            <div class="settings-input">
                <input type="number" name="v4_hcd_iterations"
                       value="{{ settings.v4_hcd_iterations }}"
                       min="1" max="100" step="1">
            </div>
        </div>

        <div class="settings-row">
            <div class="settings-label">
                <strong>HCD Epochs</strong>
                <small>IK Epochen pro Frame. Mehr Epochen verbessern die Pose-Qualit&auml;t.</small>
            </div>
            <div class="settings-input">
                <input type="number" name="v4_hcd_epochs"
                       value="{{ settings.v4_hcd_epochs }}"
                       min="1" max="200" step="1">
            </div>
        </div>

        <div class="settings-row">
            <div class="settings-label">
                <strong>HCD Learning Rate</strong>
                <small>Lernrate f&uuml;r den IK Gradient-Descent Solver.</small>
            </div>
            <div class="settings-input">
                <input type="number" name="v4_hcd_learning_rate"
                       value="{{ settings.v4_hcd_learning_rate }}"
                       min="0.0001" max="0.1" step="0.0001">
            </div>
        </div>

        {# Smoothing #}
        <div class="settings-row">
            <div class="settings-label">
                <strong>Smoothing Cutoff (Hz)</strong>
                <small>Butterworth Tiefpass-Grenzfrequenz. Niedrigere Werte = gl&auml;ttere Animation.</small>
            </div>
            <div class="settings-input">
                <input type="number" name="v4_smoothing_cutoff"
                       value="{{ settings.v4_smoothing_cutoff }}"
                       min="0.5" max="15.0" step="0.5">
            </div>
        </div>

        <div class="settings-row">
            <div class="settings-label">
                <strong>Smoothing Sampling (Hz)</strong>
                <small>Abtastfrequenz f&uuml;r den Butterworth-Filter. Sollte zur Video-FPS passen.</small>
            </div>
            <div class="settings-input">
                <input type="number" name="v4_smoothing_sampling"
                       value="{{ settings.v4_smoothing_sampling }}"
                       min="10.0" max="120.0" step="1.0">
            </div>
        </div>

        {# MediaPipe Detection #}
        <div class="settings-row">
            <div class="settings-label">
                <strong>MediaPipe Detection Confidence</strong>
                <small>Mindest-Konfidenz f&uuml;r die Pose-Erkennung (0.0&ndash;1.0).</small>
            </div>
            <div class="settings-input">
                <input type="number" name="mp_min_detection_confidence"
                       value="{{ settings.mp_min_detection_confidence }}"
                       min="0.0" max="1.0" step="0.05">
            </div>
        </div>

        <div class="settings-row">
            <div class="settings-label">
                <strong>MediaPipe Tracking Confidence</strong>
                <small>Mindest-Konfidenz f&uuml;r das Pose-Tracking (0.0&ndash;1.0). Niedrig = weniger Redetections.</small>
            </div>
            <div class="settings-input">
                <input type="number" name="mp_min_tracking_confidence"
                       value="{{ settings.mp_min_tracking_confidence }}"
                       min="0.0" max="1.0" step="0.05">
            </div>
        </div>

        <div class="settings-row">
            <div class="settings-label">
                <strong>MediaPipe Model Complexity</strong>
                <small>0 = Lite (schneller), 1 = Full (genauer).</small>
            </div>
            <div class="settings-input">
                <select name="mp_model_complexity" class="settings-select">
                    <option value="0" {% if settings.mp_model_complexity == 0 %}selected{% endif %}>0 &ndash; Lite (schnell)</option>
                    <option value="1" {% if settings.mp_model_complexity == 1 %}selected{% endif %}>1 &ndash; Full (genau)</option>
                </select>
            </div>
        </div>
    </div>

    {# ── SMPL Pipelines ── #}
    <div class="settings-card" style="margin-top:1.5rem;">
        <h2><i class="fas fa-microchip"></i> SMPL Pipelines <small style="color:#888;">Gemeinsame Einstellungen</small></h2>

        <div class="settings-row">
            <div class="settings-label">
                <strong>Device</strong>
                <small>GPU (CUDA) oder CPU f&uuml;r GVHMR, WHAM und PromptHMR.</small>
            </div>
            <div class="settings-input">
                <select name="smpl_device" class="settings-select">
                    <option value="cuda" {% if settings.smpl_device == 'cuda' %}selected{% endif %}>CUDA (GPU)</option>
                    <option value="cpu" {% if settings.smpl_device == 'cpu' %}selected{% endif %}>CPU</option>
                </select>
            </div>
        </div>

        {% if not smpl_models_ok %}
        <div style="background:rgba(231,76,60,0.1); border:1px solid rgba(231,76,60,0.3); border-radius:6px; padding:0.75rem 1rem; margin:0.5rem 0.75rem;">
            <i class="fas fa-exclamation-triangle" style="color:#e74c3c;"></i>
            <strong style="color:#e74c3c;">SMPL-Modelle fehlen</strong>
            <small style="display:block;color:#888;margin-top:0.25rem;">
                Die SMPL .pkl Dateien werden ben&ouml;tigt. Lizenz registrieren unter
                <a href="https://smpl.is.tue.mpg.de" target="_blank">smpl.is.tue.mpg.de</a>,
                dann die Dateien nach <code>VideoToBVH/models/smpl/</code> kopieren.
            </small>
        </div>
        {% endif %}
    </div>

    {# ── GVHMR ── #}
    <div class="settings-card" style="margin-top:1.5rem;">
        <h2>
            <i class="fas fa-walking"></i> GVHMR
            <small style="color:#888;">36 mm, GPU &mdash; Empfohlen</small>
            {% if gvhmr_installed %}<span style="color:#27ae60;margin-left:0.5rem;" title="Installiert"><i class="fas fa-check-circle"></i></span>
            {% else %}<span style="color:#e74c3c;margin-left:0.5rem;" title="Nicht installiert"><i class="fas fa-times-circle"></i></span>{% endif %}
        </h2>

        <div class="settings-row">
            <div class="settings-label">
                <strong>Static Camera</strong>
                <small>Statische Kamera annehmen (kein DPVO). Empfohlen f&uuml;r feste Kameraperspektive.</small>
            </div>
            <div class="settings-input">
                <label class="settings-checkbox">
                    <input type="checkbox" name="gvhmr_static_cam" {% if settings.gvhmr_static_cam %}checked{% endif %}> Aktiviert
                </label>
            </div>
        </div>

        <div class="settings-row">
            <div class="settings-label">
                <strong>Focal Length (mm)</strong>
                <small>Brennweite der Kamera in mm. Standard: 26 mm.</small>
            </div>
            <div class="settings-input">
                <input type="number" name="gvhmr_focal_length_mm"
                       value="{{ settings.gvhmr_focal_length_mm }}"
                       min="1" max="200" step="0.5">
            </div>
        </div>
    </div>

    {# ── WHAM ── #}
    <div class="settings-card" style="margin-top:1.5rem;">
        <h2>
            <i class="fas fa-globe"></i> WHAM
            <small style="color:#888;">37 mm, GPU, World-Koordinaten</small>
            {% if wham_installed %}<span style="color:#27ae60;margin-left:0.5rem;" title="Installiert"><i class="fas fa-check-circle"></i></span>
            {% else %}<span style="color:#e74c3c;margin-left:0.5rem;" title="Nicht installiert"><i class="fas fa-times-circle"></i></span>{% endif %}
        </h2>

        <div class="settings-row">
            <div class="settings-label">
                <strong>Estimate Local Only</strong>
                <small>Nur lokale K&ouml;rperbewegung sch&auml;tzen (keine globale Trajektorie).</small>
            </div>
            <div class="settings-input">
                <label class="settings-checkbox">
                    <input type="checkbox" name="wham_estimate_local_only" {% if settings.wham_estimate_local_only %}checked{% endif %}> Aktiviert
                </label>
            </div>
        </div>

        <div class="settings-row">
            <div class="settings-label">
                <strong>Run SMPLify</strong>
                <small>SMPLify-Verfeinerung ausf&uuml;hren. Langsamer aber genauer.</small>
            </div>
            <div class="settings-input">
                <label class="settings-checkbox">
                    <input type="checkbox" name="wham_run_smplify" {% if settings.wham_run_smplify %}checked{% endif %}> Aktiviert
                </label>
            </div>
        </div>
    </div>

    {# ── PromptHMR ── #}
    <div class="settings-card" style="margin-top:1.5rem;">
        <h2>
            <i class="fas fa-comment-dots"></i> PromptHMR
            <small style="color:#888;">37 mm, GPU &mdash; Beste per-frame</small>
            {% if prompthmr_installed %}<span style="color:#27ae60;margin-left:0.5rem;" title="Installiert"><i class="fas fa-check-circle"></i></span>
            {% else %}<span style="color:#e74c3c;margin-left:0.5rem;" title="Nicht installiert"><i class="fas fa-times-circle"></i></span>{% endif %}
        </h2>

        <div class="settings-row">
            <div class="settings-label">
                <strong>Static Camera</strong>
                <small>Statische Kamera annehmen. Empfohlen f&uuml;r die meisten Videos.</small>
            </div>
            <div class="settings-input">
                <label class="settings-checkbox">
                    <input type="checkbox" name="prompthmr_static_camera" {% if settings.prompthmr_static_camera %}checked{% endif %}> Aktiviert
                </label>
            </div>
        </div>
    </div>

    {# ── 3D Video Output ── #}
    <div class="settings-card" style="margin-top:1.5rem;">
        <h2><i class="fas fa-film"></i> 3D Video Output</h2>

        <div class="settings-row">
            <div class="settings-label">
                <strong>Output-Verzeichnis</strong>
                <small>Verzeichnis f&uuml;r gespeicherte Videos (Skeleton Overlay, Rig Only, 3D Character) von der Process-Seite.</small>
            </div>
            <div class="settings-input">
                <input type="text" name="video_output_dir"
                       value="{{ settings.video_output_dir }}"
                       style="width:100%;font-family:monospace;font-size:0.85rem;"
                       placeholder="A:\3DTools\HumanBodyWeb\media\output">
            </div>
        </div>
    </div>

    <div class="settings-actions">
        <button type="submit" class="btn btn-primary">
            <i class="fas fa-save"></i> Speichern
        </button>
    </div>
</form>
{% endblock %}
